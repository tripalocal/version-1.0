{% extends "app/layout.html" %}
{% load staticfiles %}
{% load i18n %}

{%block head %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="{% static 'app/content/tripalocal_search.css' %}" rel="stylesheet">
    <title>Discover {{ city }}</title>
{%endblock%}

{% block content %} 
    <form id="search_form" action="/s/melbourne/" method="post">
        {% csrf_token %}
        <div class="basicSearch">
            <div class="row">
                <div class="fixCenter">
                    <div class="dates">
                        <div class="iconHeader">
                            <div class="iconImage" id="date"></div>
                            <div class="iconText">Dates</div>
                        </div> 
                        <div class="formBoxes">
                            {{form.city}}
                            <div class="input-group startDate">
                                {{form.start_date}}
                            </div>
                            <div class="input-group endDate">
                                {{form.end_date}}
                            </div>
                        </div>
                    </div>

                    <div class="verticalBar">
                    </div>
                    <div class="people">
                        <div class="iconHeader"> 
                            <div class="iconImage" id="people">
                            </div>
                            <div class="iconText">People
                            </div>
                        </div>
                        <div class="formBoxes">{{form.guest_number}}
                        </div>
                    </div>

                    <div class="verticalBar">
                    </div>
                
                    <div class="language">
                        <div class="iconHeader">
                            <div class="iconImage" id="language">
                            </div>
                            <div class="iconText">Language
                            </div>
                        </div> 

                        <div class="formBoxes">
                            {{form.language}} 
                            <input id="language_English" type="checkbox" value="English" class="css-checkbox" name="checkbox-eng"><label id="language_English_label" for="checkbox-eng" class="css-label lite-x-cyan">English</label>
                            <br> 
                            <input id="language_Mandarin" type="checkbox" value="Chinese" class="css-checkbox" name="checkbox-cn"><label id="language_Mandarin_label" for="checkbox-cn" class="css-label lite-x-cyan" style="margin-top:10px;">中文</label> 
                        </div>
                    </div>

                    <div class="verticalBar">
                    </div>

                    <div id="searchButton">
                        <input class="btn-block btn btn-default" style="padding-bottom:25px; width:100px;" id="itinerary-search" type="submit" value="Search" name="Search">
                    </div>
                    <div id="itinerary-search-button">
                    </div>
                </div>
            </div>
        </div>
        <div class="advanceSearch" id="optional_criteria_div" style="display:none;">
            <div class="row">
                <div class="fixCenter">
                    <div class="interests">
                        <div class="iconHeader">
                            <div class="iconImage" id="interests">
                            </div>
                            <div class="iconText">Interests
                            </div>
                        </div>

                        <div class="formBoxes" id="tags_div">
                            {{form.tags}}
                            {{form.all_tags}}
                        </div>
                    </div>
                </div>      
            </div>
        </div>  
    </form>

    <div class="container-fluid searchresult">
    	<div class="row">
            <div class="fixCenter">
                <div id="more-filters-div">
                    <button class="btn-block btn btn-default" id="more_filters" type="button" value="More Filters" style="padding-bottom:25px; width:100px;float:left;">More Filters</button>
                    <div id="ajax-experience-count"></div>
                </div>
                <div id="experience-box" class="expBox">
                    <div id="overlay"></div>
                    <div id="ajax-experience-result"></div>

                    <div class="expList">
                        <div class="listingImg" style="background-image:url({{ MEDIA_URL }}request.jpg);"></div>
                        <h3>Can't find the experience you Want?</h3>

                        <div class="profile-sm"
                             style="background:url({{ MEDIA_URL }}profile_default.jpg) no-repeat; background-size:cover; background-position:center;"></div>
                        <p style="overflow-y:hidden; height:100px">Email us at <a
                                href="mailto:enquiries@tripalocal.com">enquiries@tripalocal.com</a>
                            with the preferred experience, the dates and times and we will get back to you within 48
                            hours with a customised
                            experience just for you!</p>

                        <div class="listingFooter">We offer exclusive experiences with private groups</div>
                    </div>
                </div>       
            </div>
        </div>
    </div>
    <!-- /.container -->

{% endblock %}

{% block scripts %}
<script charset="utf-8" type="text/javascript">
    $(document).ready(function(){
        mixpanel.track("Search");
        if($("#user_email").val())
        {
            mixpanel.identify($("#user_email").val());
        }

        $("#id_guest_number").addClass("guestNumber");

        $("#id_city").addClass("locationSelection");
        $("#id_city").val("{{city}}");

        language = $("#id_language").val().split(",");
        for(i=0;i<language.length;i++)
        {
            $("#language_"+language[i]).prop('checked',true);
            $("#language_"+language[i]+"_label").attr("class","css-label lite-cyan-check");
        }

        language=['English','Mandarin'];
        for(i=0;i<language.length;i++)
        {
            $("#language_"+language[i]+"_label").click(function(e){
                id = "language_"+this.id.split("_")[1];
                if($("#"+id).prop('checked'))
                {
                    $("#"+id).prop('checked',false);
                    $(this).attr("class","css-label lite-x-cyan");
                }
                else
                {
                    $("#"+id).prop('checked',true);
                    $(this).attr("class","css-label lite-cyan-check");
                }
            });
        }

        all_tags = $("#id_all_tags").val().split(",");
        tags = $("#id_tags").val().split(",");
        for(i=0;i<all_tags.length>0;i++)
        {
            if($("#id_tags").val().length>0 && tags.length>0 && $.inArray(all_tags[i], tags)<0)
            {
                new_tag = "<div id= \"tag_box_" + (i+1) + "\" class=\"tag-box tag-box-unselected\"><label id=\"tag_" + (i+1) +"\" class=\"tag-non-selected\">" + all_tags[i] + "</label><button type=\"button\" id=\"tag_button_" + (i+1) +"\" class=\"tag-button\">&#10003</button></div>";
            }
            else
            {
                new_tag = "<div id= \"tag_box_" + (i+1) + "\" class=\"tag-box tag-box-selected\"><label id=\"tag_" + (i+1) +"\" class=\"tag-selected\">" + all_tags[i] + "</label><button type=\"button\" id=\"tag_button_" + (i+1) +"\" class=\"tag-button\">&#10007</button></div>";
            }

            $("#tags_div").append(new_tag);

            $("#tag_button_"+(i+1)).click(function(e){
                id = e.target.id.split("_")[2];
                if($("#tag_"+id).attr("class") == "tag-selected")
                {
                    $("#tag_button_"+id).html("&#10003");
                    $("#tag_"+id).attr("class", "tag-non-selected");
                    $("#tag_box_"+id).removeClass("tag-box-selected");
                    $("#tag_box_"+id).addClass("tag-box-unselected");
                }
                else
                {
                    $("#tag_button_"+id).html("&#10007");
                    $("#tag_"+id).attr("class", "tag-selected");
                    $("#tag_box_"+id).removeClass("tag-box-unselected");
                    $("#tag_box_"+id).addClass("tag-box-selected");
                }
            });
        }

        $(".input-group-addon").attr("style","padding:0px; border:0px;");
        $(".glyphicon-calendar").hide();

        $("#id_start_date").click(function(){
            $("#id_start_date_picker").data("DateTimePicker").show();  
        });

        $("#id_end_date").click(function(){  
            $("#id_end_date_picker").data("DateTimePicker").show();  
        });

        $('#itinerary-search').on('click', function (event) {
            event.preventDefault();

            data = {};
            if ($("#language_English").prop('checked')) {
                data['checkbox-eng'] = "English";
            }

            if ($("#language_Mandarin").prop('checked')) {
                data['checkbox-cn'] = "Chinese";
            }

            $.post('/s/' + $("#id_city").val() + '/', $.extend({
                'csrfmiddlewaretoken': $("[name='csrfmiddlewaretoken']")[0].value,
                'city': $("#id_city").val(),
                'start_date': $("#id_start_date").val(),
                'end_date': $("#id_end_date").val(),
                'guest_number': $("#id_guest_number").val(),
                'language': $("#id_language").val(),
                'Search': "Search",
                'tags': $("#id_tags").val(),
                'all_tags': $("#id_all_tags").val()
            }, data)).done(function (response) {
                    $('#ajax-experience-result').html($(response).find('#experience-results'));
                    $('#ajax-experience-count').html($(response).find('#experience-count'));
            }).fail(function () {
                    $('#ajax-experience-result').text("Sorry but there was an error.");

            });
        });

        $("#itinerary-search").click();
    });

    $("#id_city").change(function(e){
        $("#search_form")[0].action = "/s/" + $("#id_city").val() + "/";
    });

    $("#itinerary-search").click(function(e){
        $("#id_city").change();
        $("#id_tags").val("");
        for(i=1;$("#tag_"+i).length>0;i++)
        {
            if($("#tag_"+i).attr("class") == "tag-selected")
            {
                $("#id_tags").val($("#id_tags").val() + $("#tag_"+i).text() + ",");
            }
        }
        tags = $("#id_tags").val();
        tags = tags.substring(0,tags.length-1);
        $("#id_tags").val(tags);

        $("#id_language").val("");

        language = ['Mandarin','English'];
        for(i=0;i<language.length;i++)
        {
            if($("#language_"+language[i]).prop('checked') == true)
            {
                $("#id_language").val($("#id_language").val() + language[i] + ",");
            }
        }
        l = $("#id_language").val();
        l = l.substring(0,l.length-1);
        $("#id_language").val(l);

    });

    $("#more_filters").click(function(e){
        tags_div = $("#optional_criteria_div");
        if(tags_div.css("display")=="none")
        {
            tags_div.show();
            $("#more_filters").text("Less Filters");
        }
        else
        {
            tags_div.hide();
            $("#more_filters").text("More Filters");
        }
    });
</script>
{% endblock %}