{% extends "app/layout.html" %}
{% load mathfilters %}

{% block head %}
    {% load staticfiles %}
    <script language="javascript" type="text/javascript" src="{% static 'app/scripts/jquery.stickem.js' %}"></script>
    <title></title>
{% endblock %}

{% block content %}
<div>
    <form id="itinerary_form" action="" method="post">
        {% csrf_token %}
        <table class="">
            <tbody>
                <tr>
                    <td class="">{{form.start_datetime}}</td>
                    <td class="">{{form.end_datetime}}</td>
                    <td class="">{{form.guest_number}}</td>
                    <td class="">{{form.city}}</td>
                    <td class="">{{form.tags}}</td>
                    <td class=""><input id="itinerary-search" type="submit" value="Search" name="Search" class="btn btn-primary btn-sm btn-search"></td>
                </tr>
            </tbody>
        </table>
    </form>
    {% if itinerary %}
    <div id="itinerary_div">
        <table id="itinerary_table" style="border:1px solid; margin:20px;">
            <tbody>
            {%for day in itinerary%}
                <tr style="border:1px solid;">
                    <td style="border:1px solid;">{{day.date}}</td>
                    {% for experience in day.experiences %}
                    {% if forloop.counter <= 3 %}
                    <td style="border:1px solid;width:400px;height:100px;">
                    {% else %}
                    <td style="border:1px solid;width:400px;height:100px;display:none;">
                    {% endif %}
                        <div style="width: 100%; overflow: hidden; height:50px;">
                            <div style="width: 100px; float: left;">
                                <p style="display:none;">{{experience.id}}</p>
                                <p style="display:none;">{{experience.duration}}</p>
                                <p style="display:none;">{{experience.host}}</p>
                                <p style="display:none;">{{experience.host_image}}</p>
                                <p style="display:none;">{{experience.price}}</p>
                                <a href="/experience/{{experience.id}}" target="_blank">
                                    <img src="{{MEDIA_URL}}thumbnails/experiences/experience{{experience.id}}_1.jpg" alt="{{experience.title}}" height="50" width="100"/>
                                </a>
                            </div>
                            <div style="margin-left: 110px;">
                                <a href="/experience/{{experience.id}}" target="_blank"><p>{{experience.title}}</p></a>
                                <select>
                                    <option value="None">Please select time</option>
                                {% for slot in experience.timeslots%}
                                    <option value="{{slot.time_string}}" instant_booking="{{slot.instant_booking}}">{{slot.time_string}}:00 - {{slot.time_string|add:experience.duration|mod:24}}:00{%if slot.instant_booking%}(I){%else%}{%endif%}</option>
                                {%endfor%}
                                </select>
                            </div>
                        </div>
                        <div style="width:400px;height:50px;">
                            <div>
                                <p>{{experience.meetup_spot}}</p>
                            </div>
                            <div style="">
                                <input type="radio" value="yes">Yes
                                <input type="radio" value="no">No
                            </div>
                        </div>
                    </td>
                    {%endfor%}
                </tr>
            {%endfor%}
            </tbody>
        </table>
        <input id="itinerary-preview" type="button" value="Preview" name="Preview" class="btn btn-primary btn-sm btn-search">
    </div>

    <div id="preview_div" style="display:none;position:absolute;top:150px;left:100px;margin-right:100px;z-index=1000;background-color:rgba(255,255,255,0.5);">
        <div id="preview_content"></div>
        <div>
            <button id="preview_change">Change</button>
            <button id="preview_confirm">Confirm</button>
        </div>
    </div>
    {%endif%}
</div>
{% endblock %}

{% block scripts %}
<script charset="utf-8" type="text/javascript">
    function hideexperience(i, j)
    {
        $("#day_"+i+"_exp_"+j).hide();
        //$($(experience.children()[0]).children()[0]).hide();
        //$($($(experience.children()[0]).children()[1]).children()[1]).hide();
        //$(experience.children()[1]).hide();
        j++;
        while($("#day_"+i+"_exp_"+j).length && ($("#day_"+i+"_exp_"+j+"_choice_no").is(':checked') || $("#day_"+i+"_exp_"+j).attr("style").split(" ").join("").indexOf("display:none")<0))
        //skip exps that (1)with "no" checked or (2)already shown
        {
            j++;
        }
        if($("#day_"+i+"_exp_"+j).length)
        {
            $("#day_"+i+"_exp_"+j).show();
        }
    }

    $(document).ready(function(){

        var table = $("#itinerary_table")[0];

        if(table)
        {
/*
            $("#itinerary_table").each(function () {
                var $this = $(this);
                var newrows = [];
                $this.find("tr").each(function () {
                    var i = 0;
                    $(this).find("td,th").each(function () {
                        i++;
                        if (newrows[i] === undefined) {
                            newrows[i] = $("<tr></tr>");
                        }
                        newrows[i].append($(this));
                    });
                });
                $this.find("tr").remove();
                $.each(newrows, function () {
                    $this.append(this);
                });
            });
*/

            for (var i = 0, row; row = table.rows[i]; i++) {
                for (var j = 0, col; col = row.cells[j]; j++) {
                    if(j==0)//i==0
                    {
                        //col.id="day_"+(j+1);
                        col.id="day_"+(i+1);
                    }
                    else
                    {
                        day_index = i+1;//j+1;
                        exp_index = j;//i;
                        col.id="day_"+day_index+"_exp_"+exp_index;
                        $($($(col).children()[0]).children()[0]).children()[0].id="day_"+day_index+"_exp_"+exp_index+"_id";
                        $($($(col).children()[0]).children()[0]).children()[1].id="day_"+day_index+"_exp_"+exp_index+"_duration";
                        $($($(col).children()[0]).children()[0]).children()[2].id="day_"+day_index+"_exp_"+exp_index+"_host";
                        $($($(col).children()[0]).children()[0]).children()[3].id="day_"+day_index+"_exp_"+exp_index+"_host_image";
                        $($($(col).children()[0]).children()[0]).children()[4].id="day_"+day_index+"_exp_"+exp_index+"_price";
                        $($($(col).children()[0]).children()[1]).children()[1].id="day_"+day_index+"_exp_"+exp_index+"_timeslot";
                        $($($(col).children()[0]).children()[1]).children()[0].id="day_"+day_index+"_exp_"+exp_index+"_title";
                        $($(col).children()[1]).children()[0].id="day_"+day_index+"_exp_"+exp_index+"_meetup_spot";
                        $($(col).children()[1]).children()[1].id="day_"+day_index+"_exp_"+exp_index+"_choice";
                        $($($(col).children()[1]).children()[1]).children()[0].id="day_"+day_index+"_exp_"+exp_index+"_choice_yes";
                        $($($(col).children()[1]).children()[1]).children()[1].id="day_"+day_index+"_exp_"+exp_index+"_choice_no";
                        $($($(col).children()[1]).children()[1]).children()[0].name="day_"+day_index+"_exp_"+exp_index+"_radio";
                        $($($(col).children()[1]).children()[1]).children()[1].name="day_"+day_index+"_exp_"+exp_index+"_radio";
/*
                        $("#day_"+day_index+"_exp_"+exp_index).mouseover(
                            function(e){
                                target = $(e.target);
                                while(target[0].id.indexOf("day_") < 0)
                                {
                                    target=target.parent();
                                }
                                i = target[0].id.split('_')[1];
                                j = target[0].id.split('_')[3];
                                $("#day_"+i+"_exp_"+j+"_meetup_spot").attr("style","display:none;");
                                $("#day_"+i+"_exp_"+j+"_choice").attr("style","");
                            }
                        );
                        $("#day_"+day_index+"_exp_"+exp_index).mouseout(
                            function(e){
                                target = $(e.target);
                                while(target[0].id.indexOf("day_") < 0)
                                {
                                    target=target.parent();
                                }
                                i = target[0].id.split('_')[1];
                                j = target[0].id.split('_')[3];
                                $("#day_"+i+"_exp_"+j+"_meetup_spot").attr("style","");
                                $("#day_"+i+"_exp_"+j+"_choice").attr("style","display:none;");
                            }            
                        );
*/
                        $("#day_"+day_index+"_exp_"+exp_index+"_choice_yes").click(function(e){
                            i = e.target.id.split('_')[1];
                            j = e.target.id.split('_')[3];
                            if($("#day_"+i+"_exp_"+j+"_timeslot option:selected").val() == "None")
                            {
                                alert("Please select the time first. Thank you :)");
                                $(this).prop('checked', false);
                            }
                            else
                            {
                                //hideexperience(i, j);
                                $("#day_"+i+"_exp_"+j).css('background-color', 'grey');
                            }
                        });

                        $("#day_"+day_index+"_exp_"+exp_index+"_choice_no").click(function(e){
                            i = e.target.id.split('_')[1];
                            j = e.target.id.split('_')[3];
                            hideexperience(i, j);
                        });
                    }
                }  
            }
        }
    });

    $("#itinerary-preview").click(function(e){
        var table = $("#itinerary_table")[0];
        var itinerary = [];
        for (var i = 0, row; row = table.rows[i]; i++) {
            for (var j = 0, col; col = row.cells[j]; j++) {
                if($("#day_"+(i+1)+"_exp_"+j+"_choice_yes").length && $("#day_"+(i+1)+"_exp_"+j+"_choice_yes").is(':checked'))
                {
                    dict={"id":$("#day_"+(i+1)+"_exp_"+j+"_id").text(),"title":$("#day_"+(i+1)+"_exp_"+j+"_title").text(),
                          "date":$("#day_"+(i+1)).text(),"time":$("#day_"+(i+1)+"_exp_"+j+"_timeslot option:selected").text(),
                          "guest_number":$("#id_guest_number option:selected").text()};
                    itinerary.push(dict);

                    host = $("#day_"+(i+1)+"_exp_"+j+"_host").text();
                    host_image = "/images/" + $("#day_"+(i+1)+"_exp_"+j+"_host_image").text();
                    price = (parseFloat($("#day_"+(i+1)+"_exp_"+j+"_price").text())*1.429).toFixed(2);
                    sub_total = price * parseInt(dict['guest_number']);
                    duration = $("#day_"+(i+1)+"_exp_"+j+"_duration").text();

                    new_item = "<div class=\"expList\">" +
                                    "<div class=\"listingImg\" style=\"background-image:url(/images/thumbnails/experiences/experience" + dict['id'] + "_1.jpg)\">" +
                                        "<div class=\"profile-md checkout-profile\">" + 
                                            "<img src=\"" + host_image + "\" width=\"40\" height=\"40\">" +
                                        "</div>" + 
                                    "</div>" +
                                    "<div class=\"checkoutBox checkoutInfo\">" +
                                        "<h3 style=\"height:30px;\">" + dict['title'] + " with " + host + "</h3>" +
                                        "<p>Reservation for <strong>" + dict['guest_number'] + " person(s)</strong><br>" +
                                           "on <strong>" + dict['date'] + "</strong> from <strong>" + dict['time'] + "</strong><br>" +
                                        "<hr style=\"margin-bottom:10px;\">" +
                                        "<p>Rate: $" + price +" per person for " + duration + " hours * " + dict['guest_number'] + " = $" + sub_total + "</p>" +
                                    "</div>" +
                                "</div>";

                    $("#preview_content").html($("#preview_content").html() + new_item);
                    $("#itinerary_div *").prop("disabled", true);
                    $("#itinerary_div").css('opacity', '0.1');
                    $("#preview_div").show();
                }
            }
        }
        if(itinerary.length==0)
        {
            alert("You have not selected any experience.");
        }
        else
        {
            //alert(JSON.stringify(itinerary));
        }
    });

    $("#preview_change").click(function(e){
        $("#itinerary_div *").prop("disabled", false);
        $("#itinerary_div").css('opacity', '1.0');
        $("#preview_content").empty();
        $("#preview_div").hide();
    });

    $("#preview_confirm").click(function(e){
        $("#itinerary_div *").prop("disabled", false);
        $("#itinerary_div").css('opacity', '1.0');
        $("#preview_content").empty();
        $("#preview_div").hide();
    });
</script>
{% endblock %}
