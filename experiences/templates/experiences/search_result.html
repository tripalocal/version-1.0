{% extends "app/layout.html" %}
{% load staticfiles %}
{% load mathfilters %}
{% load i18n %}

{%block head %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.0.7/components/dropdown.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.0.7/components/transition.min.css" rel="stylesheet">
    <link href="{% static 'experiences/content/tripalocal_search.css' %}" rel="stylesheet">
    <link href="{% static 'experiences/content/tripalocal_search_async.css' %}" rel="stylesheet">
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.0.7/components/dropdown.min.js"></script>
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.0.7/components/transition.min.js"></script>
    <title>{%trans "Discover" %} {{ city_display_name }}</title>
{%endblock%}

{% block content %}
    <form id="search_form" action="/s/melbourne/" method="post">
        {% csrf_token %}
        <div class="basicSearch notOnMobile">
            <div class="row">
                <div class="fixCenter">
                    <div class="dates">
                        <div class="iconHeader">
                            <div class="iconImage" id="date"></div>
                            <div class="iconText">Dates</div>
                        </div>
                        <div class="formBoxes">
                          <div class="ui selection dropdown">
                            <input id="id_city" type="hidden" name="city" value="city">
                            <i class="dropdown icon"></i>
                            <div id="city_name" class="text">City</div>
                            <div id="city-menu" class="menu"></div>
                          </div>
                            <div class="input-group startDate">
                                {{form.start_date}}
                            </div>
                            <div class="input-group endDate">
                                {{form.end_date}}
                            </div>
                        </div>
                    </div>

                    <div class="verticalBar">
                    </div>
                    <div class="people">
                        <div class="iconHeader">
                            <div class="iconImage" id="people">
                            </div>
                            <div class="iconText">{%trans "People"%}
                            </div>
                        </div>
                        <div class="formBoxes">{{form.guest_number}}
                        <script charset="utf-8" type="text/javascript">
                        $('.ui.dropdown')
                          .dropdown()
                        ;
                        </script>
                        </div>
                    </div>

                    <div class="verticalBar">
                    </div>

                    <div class="language">
                        <div class="iconHeader">
                            <div class="iconImage" id="language">
                            </div>
                            <div class="iconText">{%trans "Language"%}
                            </div>
                        </div>

                        <div class="formBoxes">
                            {{form.language}}
                            <input id="language_English" type="checkbox" value="English" class="css-checkbox" name="checkbox-eng"><label id="language_English_label" for="checkbox-eng" class="css-label lite-x-cyan">English</label>
                            <br>
                            <input id="language_Mandarin" type="checkbox" value="Chinese" class="css-checkbox" name="checkbox-cn"><label id="language_Mandarin_label" for="checkbox-cn" class="css-label lite-x-cyan" style="margin-top:18px;">中文</label>
                        </div>
                    </div>

                    <div class="verticalBar">
                    </div>

                    <div id="searchButton">
                        <!--<input id="auto_update" type="checkbox" class="css-checkbox" ><label id="auto_update_label" for="checkbox-cn" class="css-label lite-x-cyan" style="margin:5px 0 15px 0;font-weight:normal">{% trans "Auto update"%}</label>-->
                        <input class="btn-block btn btn-default" style="padding-bottom:25px; width:100px;" id="itinerary-search" type="submit" value="{% trans "Update" %}" name="{% trans "Search" %}">
                    </div>
                    <div id="itinerary-search-button">
                    </div>
                </div>
            </div>
        </div>
        <div class="advanceSearch notOnMobile" id="optional_criteria_div" style="display:none;">
            <div class="row" style="background-color:white;padding-bottom:10px">
                <div class="fixCenter">
                    <div class="interests">
                        <div class="iconHeader">
                            <div class="iconImage" id="interests">
                            </div>
                            <div class="iconText">{%trans "Interests"%}
                            </div>
                        </div>

                        <div class="formBoxes" id="tags_div">
                            {{form.tags}}
                            {{form.all_tags}}
                        </div>
                        <div class="formBoxes" id="only_tags">
                            {{ form.is_kids_friendly }}
                            <label for="{{ form.is_kids_friendly.id_for_label }}"
                                   class="css-label lite-cyan-check only-tag-label">
                                {%trans "Kids friendly only"%}</label>

                            {{ form.is_host_with_cars }}
                            <label for="{{ form.is_host_with_cars.id_for_label }}"
                                   class="css-label lite-cyan-check only-tag-label">
                                {%trans "Hosts with cars only"%}</label>

                            {{ form.is_private_tours }}
                            <label for="{{ form.is_private_tours.id_for_label }}"
                                   class="css-label lite-cyan-check only-tag-label">
                                {%trans "Private tours only"%}</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mobileSearch notOnDesktop">
            <h1 style="float:left;margin:15px 20px -10px 20px">{%trans "Melbourne, VIC"%}</h1>
            <img src="{{ MEDIA_URL }}search.svg" width="25" style="float:right;margin:15px 20px -10px 20px">
        </div>
    </form>

    <div class="container-fluid searchresult">
      <div class="loading"><img src="{% static 'experiences/img/loading.gif' %}" width="64px" height="64px" class="ajax-loader"/></div>
    	<div class="row">
            <div class="fixCenter">
                <div id="more-filters-div" class="notOnMobile">
                    <button class="btn-block btn btn-default" id="more_filters" type="button" value="More Filters" style="padding-bottom:25px; width:100px;float:left;margin-right:10px;">{%trans "More Filters" %}</button>
                    <button class="btn-block btn btn-primary" id="apply_filters" type="button" value="Apply Filters" style="width:100px;display:none">{% trans "Apply Filters" %}</button>
                    <div id="ajax-experience-count" style="position:relative;"></div>
                </div>
                <div id="experience-box" class="expBox">
                    <div id="overlay"></div>
                    <div id="ajax-experience-result"></div>
                    <div class="expList custom-itinerary" style="background-image:url({% static 'experiences/img/searchpage_banner.jpg' %});">
                      <button class="btn btn-primary request-btn">Request a trip</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /.container -->

{% endblock %}

{% block scripts %}
<script charset="utf-8" type="text/javascript">
  $(document).ajaxStart(function() {
    $(".loading").show();
  });
  $(document).ajaxStop(function() {
    $(".loading").hide();
  })
  $(document).ready(function() {
    $(".request-btn").click(function() {
      window.location.href="mailto:enquiries@tripalocal.com";
      mixpanel.track("requested a trip from searchpage");
    });
  });
</script>

<script charset="utf-8" type="text/javascript">
    function hrefToCityName(href) {
        if (href.substr(-1) === '/') {
            temp = href.substr(0, href.length - 1);
        }

        return temp.substr(temp.lastIndexOf("/") + 1);
    }

    function loadExperienceList(href) {
        var data = {};
        if ($("#language_English").prop('checked')) {
            data['checkbox-eng'] = "English";
        }

        if ($("#language_Mandarin").prop('checked')) {
            data['checkbox-cn'] = "Chinese";
        }

        var only_tags = ['is_host_with_cars', 'is_kids_friendly', 'is_private_tours'];
        for (var i = 0; i < only_tags.length; ++i) {
            if ($('#id_' + only_tags[i]).prop('checked')) {
                data[only_tags[i]] = "on";
            }
        }

        var city = hrefToCityName(href);

        $.post(href, $.extend({
            'csrfmiddlewaretoken': $("[name='csrfmiddlewaretoken']")[0].value,
            'city': city,
            'start_date': $("#id_start_date").val(),
            'end_date': $("#id_end_date").val(),
            'guest_number': $("#id_guest_number").val(),
            'language': $("#id_language").val(),
            'Search': "Search",
            'tags': $("#id_tags").val(),
            'all_tags': $("#id_all_tags").val()
        }, data)).done(function (response) {
            $('#ajax-experience-result').html($(response).find('#experience-results'));
            $('#ajax-experience-count').html($(response).find('#experience-count'));
        }).fail(function () {
            $('#ajax-experience-result').text("Sorry but there was an error.");
        });
    }

    $(document).ready(function(){
        mixpanel.track("Search");
        if($("#user_email").val())
        {
            mixpanel.identify($("#user_email").val());
        }

        {% for k, v in locations %}
            var header = '<div class=\"header\">' + '{{ k }}' + '</div>';
            $('#city-menu').append(header);
            {% for id, name, state in v %}
                var city = '<div class=\"item\" data-value=' + '{{ id }}' +
                        ' data-text=' + '{{ name }}' + '>' + '{{ name }} ' +
                        '<span class=\"light-color\">' + '{{ state }}' + '</span></div>';
                $('#city-menu').append(city);
            {% endfor %}
        {% endfor %}

        $("#city_name").text("{{city}}");
        $('.ui.dropdown').dropdown();

        $("#id_guest_number").addClass("guestNumber");

        $("#id_city").addClass("locationSelection");
        $("#id_city").val("{{city}}");

        language = $("#id_language").val().split(",");
        for(i=0;i<language.length;i++)
        {
            $("#language_"+language[i]).prop('checked',true);
            $("#language_"+language[i]+"_label").attr("class","css-label lite-cyan-check");
        }

        language=['English','Mandarin'];
        for(i=0;i<language.length;i++)
        {
            $("#language_"+language[i]+"_label").click(function(e){
                id = "language_"+this.id.split("_")[1];
                if($("#"+id).prop('checked'))
                {
                    $("#"+id).prop('checked',false);
                    $(this).attr("class","css-label lite-x-cyan");
                }
                else
                {
                    $("#"+id).prop('checked',true);
                    $(this).attr("class","css-label lite-cyan-check");
                }
            });
        }

        all_tags = $("#id_all_tags").val().split(",");
        tags = $("#id_tags").val().split(",");
        for(i=0;i<all_tags.length>0;i++)
        {
            if($("#id_tags").val().length>0 && tags.length>0 && $.inArray(all_tags[i], tags)<0)
            {
                new_tag = "<div id= \"tag_box_" + (i+1) + "\" class=\"tag-box tag-box-unselected\"><label id=\"tag_" + (i+1) +"\" class=\"tag-non-selected\">" + all_tags[i] + "</label><button type=\"button\" id=\"tag_button_" + (i+1) +"\" class=\"tag-button\">&#10003</button></div>";
            }
            else
            {
                new_tag = "<div id= \"tag_box_" + (i+1) + "\" class=\"tag-box tag-box-selected\"><label id=\"tag_" + (i+1) +"\" class=\"tag-selected\">" + all_tags[i] + "</label><button type=\"button\" id=\"tag_button_" + (i+1) +"\" class=\"tag-button\" style=\"background-image:url({{ MEDIA_URL }}closeIcon-02.svg)\"></button></div>";
            }

            $("#tags_div").append(new_tag);

            $("#tag_button_"+(i+1)).click(function(e){
                id = e.target.id.split("_")[2];
                if($("#tag_"+id).attr("class") == "tag-selected")
                {
                    $("#tag_button_"+id).css("background-image","url({{ MEDIA_URL }}undo.svg)");
                    $("#tag_"+id).attr("class", "tag-non-selected");
                    $("#tag_box_"+id).removeClass("tag-box-selected");
                    $("#tag_box_"+id).addClass("tag-box-unselected");
                }
                else
                {
                    $("#tag_button_"+id).css("background-image","url({{ MEDIA_URL }}closeIcon-02.svg)");
                    $("#tag_"+id).attr("class", "tag-selected");
                    $("#tag_box_"+id).removeClass("tag-box-unselected");
                    $("#tag_box_"+id).addClass("tag-box-selected");
                }
            });
        }

        $(".input-group-addon").attr("style","padding:0px; border:0px;");
        $(".glyphicon-calendar").hide();

        $("#id_start_date").click(function(){
            $("#id_start_date_picker").data("DateTimePicker").show();
        });

       $("#id_start_date, #id_end_date").focusout(function () {
            if ($("#id_start_date").val() != "" && $("#id_end_date").val() != "") {
                $("#itinerary-search").click();
            }
        });

        $("#id_end_date").click(function(){
            $("#id_end_date_picker").data("DateTimePicker").show();
        });

        $("#id_guest_number").change(function () {
            $("#itinerary-search").click()
        });

        $("#language_English_label, #language_Mandarin_label").click(function () {
            $("#itinerary-search").click()
        });


        $('#itinerary-search').on('click', function (event) {
            event.preventDefault();
            var href = '/s/' + $("#id_city").val() + '/';
            history.pushState({}, 'City', href);
            loadExperienceList(href);
        });

        $(window).on("popstate", function (e) {
            if (e.originalEvent.state !== null) {
                var city = hrefToCityName(location.href);
                $("#id_city").val(city);
                $("#city_name").text(city);
                loadExperienceList(location.href);
            }
        });

        $("#itinerary-search").click();
    });

    $("#id_city").change(function(e){
        $("#search_form")[0].action = "/s/" + $("#id_city").val() + "/";
        $("#itinerary-search").click()
    });

    $("#itinerary-search").click(function(e){
        $("#id_tags").val("");
        for(i=1;$("#tag_"+i).length>0;i++)
        {
            if($("#tag_"+i).attr("class") == "tag-selected")
            {
                $("#id_tags").val($("#id_tags").val() + $("#tag_"+i).text() + ",");
            }
        }
        tags = $("#id_tags").val();
        tags = tags.substring(0,tags.length-1);
        $("#id_tags").val(tags);

        $("#id_language").val("");

        language = ['Mandarin','English'];
        for(i=0;i<language.length;i++)
        {
            if($("#language_"+language[i]).prop('checked') == true)
            {
                $("#id_language").val($("#id_language").val() + language[i] + ",");
            }
        }
        l = $("#id_language").val();
        l = l.substring(0,l.length-1);
        $("#id_language").val(l);

    });

    $("#more_filters").click(function(e){
        tags_div = $("#optional_criteria_div");
        if(tags_div.css("display")=="none")
        {
            tags_div.show();
            $("#more_filters").text("Cancel");
            $("#apply_filters").show();
        }
        else
        {
            tags_div.hide();
            $("#more_filters").text("More Filters");
            $("#apply_filters").hide();
        }
    });

    $("#apply_filters").click(function(e){
        $("#itinerary-search").click();
    });
</script>
{% endblock %}
