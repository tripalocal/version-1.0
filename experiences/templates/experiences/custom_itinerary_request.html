{% extends "app/layout.html" %}
{% load staticfiles %}
{% load mathfilters %}
{% load i18n %}

{% block head %}
<title>{% trans 'Request a Custom Itinerary' %}</title>
<link href="//cdnjs.cloudflare.com/ajax/libs/fullPage.js/2.7.6/jquery.fullPage.min.css" rel="stylesheet"/>
<link href="{% static 'bootstrap3_datetime/css/bootstrap-datetimepicker.min.css' %}" rel="stylesheet">
<link href="{% static 'experiences/content/itinerary-request.css' %}" rel="stylesheet"/>
{% endblock %}

{% block content %}
{% for field in form.hidden_fields %}
  {{ field }}
{% endfor %}
<div class="loading"></div>


<div id="fullpage">
  <div class="section" id="intro">
    <div class="container">
      <h1>{% trans 'Custom Itinerary' %}</h1>
      <h2 style="margin-bottom: 100px;">{% trans 'Answer just a few questions and we will build a custom itinerary for your trip' %}</h2>
      <button id="start-btn" class="btn btn-primary main-btn animated infinite pulse">{% trans 'Get started' %}</button>
    </div>
  </div>

  <div id="city-section" class="section">
    <div class="container">
      <h1>{% trans 'Choose some locations you would like to visit on this trip.' %} <span class="asterisk">*</span></h1>
      <div class="btn btn-clear btn-selectable city">{% trans 'Melbourne' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Sydney' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Gold Coast' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Brisbane' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Cairns' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Adelaide' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Tasmania' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Alice Springs' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Darwin' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'Perth' %}</div>
      <div class="btn btn-clear btn-selectable city">{% trans 'New Zealand' %}</div>
      <button class="btn btn-primary main-btn next-btn animated infinite pulse">{% trans "Next" %}</button>
    </div>
  </div>

  <div id="date-section" class="section">
    <div class="container">
      <h1>{% trans "Select the start and end dates of your trip" %} <span class="asterisk">*</span></h1>
      <div class="form-group"><label>{% trans "Start Date" %}</label>{{form.start_date}}</div>
      <div class="form-group"><label>{% trans "End Date" %}</label>{{form.end_date}}</div>
      <button class="btn btn-primary main-btn next-btn animated infinite pulse">{% trans "Next" %}</button>
    </div>
  </div>

  <div id="guest-section" class="section">
    <div class="container">
      <h1>{% trans 'How many adults will be travelling?<br>Any children or infants?' %} <span class="asterisk">*</span></h1>
      <div class="form-group">
          <label>{% trans 'Adults' %}</label>
          {{form.guests_adults}}
      </div>
      <div class="form-group">
        <label>{% trans 'Children (2-12)' %}</label>
        {{form.guests_children}}
      </div>
      <div class="form-group">
        <label>{% trans 'Infants (< 2)' %}</label>
        {{form.guests_infants}}
      </div>
      <button class="btn btn-primary main-btn next-btn animated infinite pulse" style="display:block">{% trans "Next" %}</button>
    </div>
  </div>

  <div id="interests-section" class="section">
    <div class="container">
      <h1>{% trans "What kind of things are you interested in?<br>Check the topics that interest you." %}</h1>
      <div class="btn btn-clear btn-selectable interest">{% trans 'food & wine' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'photography' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'history & culture' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'architecture' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'for couples' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'outdoor & nature' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'shopping' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'sports & leisure' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'extreme fun' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'events' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'health & beauty' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'livability research' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'education' %}<span class="glyphicon glyphicon-plus"></span></div>
      <div class="btn btn-clear btn-selectable interest">{% trans 'local experiences' %}<span class="glyphicon glyphicon-plus"></span></div>
      <button class="btn btn-primary main-btn next-btn animated infinite pulse">{% trans "Next" %}</button>
    </div>
  </div>

  <div class="section">
    <div class="container" id="whats-included">
      <h1 id="budget-mount" data-toggle="tooltip" title="{% trans 'Please fill in more fields for a live update.' %}">{% trans "What's included" %} <span class="asterisk">*</span></h1>
      <div class="form-inline">
        <label>{% trans 'Car + Driver' %}</label>
        <input id="car-driver" type="hidden">
        <div class="btn btn-clear btn-selectable option">{% trans "none" %}</div>
        <div class="btn btn-clear btn-selectable option">{% trans "infrequent" %}</div>
        <div class="btn btn-clear btn-selectable option">{% trans "frequent" %}</div>
        <div class="btn btn-clear btn-selectable option">{% trans "whole trip" %}</div>
      </div>
      <div class="form-inline" id="form-accommodation">
        <label>{% trans 'Accommodation' %}</label>
        <input id="accommodation" type="hidden">
        <div class="btn btn-clear btn-selectable option">{% trans "none" %}</div>
        <div class="btn btn-clear btn-selectable option">{% trans "3 star" %}</div>
        <div class="btn btn-clear btn-selectable option">{% trans "4 star" %} </div>
        <div class="btn btn-clear btn-selectable option">{% trans "5 star" %}</div>
      </div>
      <div class="form-inline" id="form-flight">
        <label>{% trans 'National Flight' %}</label>
        <input id="national-flight" type="hidden"> 
        <div class="btn btn-clear btn-selectable option">{% trans "none" %}</div>
        <div class="btn btn-clear btn-selectable option">{% trans "economy" %}</div>
      </div>
      <div class="form-inline" id="form-language">
        <label>{% trans 'Service Language' %}</label>
        <input id="service-language" type="hidden">
        <div class="btn btn-clear btn-selectable option">{% trans 'chinese' %}</div>
        <div class="btn btn-clear btn-selectable option">{% trans 'english' %}</div>
      </div>
      <div class="form-inline" id="form-transfer">
        <label>{% trans 'Airport Transfer' %}</label>
        <input id="airport-transfer" type="hidden">
        <div class="btn btn-clear btn-selectable option">{% trans 'none' %}</div>
        <div class="btn btn-clear btn-selectable option">{% trans 'yes' %}</div>
      </div>
      <button class="btn btn-primary main-btn next-btn animated infinite pulse">{% trans "Next" %}</button>
    </div>
  </div>

  <div class="section">
    <div class="container">
      <h1>{% trans 'Anything else you would like to let us know?' %}</h1>
      {{form.requirements}}
      <button class="btn btn-primary main-btn next-btn animated infinite pulse" style="display:block">{% trans "Next" %}</button>
    </div>
  </div>

  <div id="contact-section" class="section">
    <div class="container">
      <h1>{% trans "Almost done!<br>Please leave us your contact details below." %} <span class="asterisk">*</span></h1>
      <div class="row" style="margin-top: 20px;">
        <div class="col-sm-6">
          <div class="form-group">
            {{form.name}}
          </div>
          <div class="form-group">
            {{form.email}}
          </div>
        </div>
        <div class="col-sm-6">
          <div class="form-group">
            {{form.wechat}}
          </div>
          <div class="form-group">
            {{form.mobile}}
          </div>
        </div>
      </div>
      <button class="btn btn-primary main-btn next-btn animated infinite pulse">{% trans "Next" %}</button>
    </div>
  </div>

  <div class="section">
    <div class="container" id="success-page">
      <h1>{% trans "Make sure you've filled in all the " %} <span class="asterisk">*{% trans "sections" %}</span></h1>
      <h2>{% trans "A travel consultant will call you within 4 hours and an itinerary will be sent to you within 48 hours. We will call you between 9am - 9pm Beijing time. Itinerary will be sent to you 48 hours after the phone call." %}</h2>
      <button id="submit-btn" class="btn btn-primary main-btn animated infinite pulse">{% trans "Submit" %}</button>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'bootstrap3_datetime/js/moment.min.js' %}"></script>
<script src="{% static 'bootstrap3_datetime/js/bootstrap-datetimepicker.min.js' %}"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fullPage.js/2.7.6/jquery.fullPage.min.js"></script>
{%if LANGUAGE == "zh-CN"%}
<script type="text/javascript" src="{% static 'bootstrap3_datetime/js/locales/bootstrap-datetimepicker.zh-CN.js' %}"></script>
{%endif%}
<script>
$(document).ready(function() {
  // Init calendars
  if (window.location.pathname.indexOf("/cn") > -1 || window.location.href.indexOf(".cn") > -1) {
    $("#id_start_date").datetimepicker({
      format: 'YYYY-MM-DD', locale: 'zh-CN',
      minDate: moment(),
      ignoreReadonly: true,
      inline: true,
      keepOpen: true,
      debug: true
    });
    $("#id_end_date").datetimepicker({
      format: 'YYYY-MM-DD', locale: 'zh-CN',
      useCurrent: false,
      ignoreReadonly: true,
      inline: true,
      keepOpen: true,
      debug: true
    });

    $("#id_start_date").on("dp.change", function (e) {
      $('#id_end_date').data("DateTimePicker").minDate(e.date);
      if ($('#id_end_date').val()) {
        $('#date-section').find('.next-btn').attr('style', 'display:block');
      }
    });
    $("#id_end_date").on("dp.change", function (e) {
      $('#id_start_date').data("DateTimePicker").maxDate(e.date);
      if ($('#id_start_date').val()) {
        $('#date-section').find('.next-btn').attr('style', 'display:block');
      }
    });
  }
  else {
    $("#id_start_date").datetimepicker({
      format: 'YYYY-MM-DD',
      minDate: moment(),
      ignoreReadonly: true,
      inline: true,
      keepOpen: true,
      debug: true
    });
    $("#id_end_date").datetimepicker({
      format: 'YYYY-MM-DD',
      useCurrent: false,
      ignoreReadonly: true,
      inline: true,
      keepOpen: true,
      debug: true
    });

    $("#id_start_date").on("dp.change", function (e) {
      $('#id_end_date').data("DateTimePicker").minDate(e.date);
      if ($('#id_end_date').val()) {
        $('#date-section').find('.next-btn').attr('style', 'display:block');
      }
    });
    $("#id_end_date").on("dp.change", function (e) {
      $('#id_start_date').data("DateTimePicker").maxDate(e.date);
      if ($('#id_start_date').val()) {
        $('#date-section').find('.next-btn').attr('style', 'display:block');
      }
    });
  }
  
  // Clear the date fields
  $('#id_start_date').val('').datetimepicker('show');
  $('#id_end_date').val('').datetimepicker('show');

	// Initialise fullpage 
	$('#fullpage').fullpage({
		responsiveWidth: 500,
		paddingTop: '50px',
		paddingBottom: '50px',
		navigation: true,
		navigationPosition: 'left',
		showActiveTooltip: false,
		anchors: ['section1', 'section2', 'section3', 'section4', 'section5', 'section6', 'section7', 'section8', 'section9'],
		navigationTooltips: ['{% trans "Start" %}', '{% trans "Destinations" %}', '{% trans "Dates" %}', '{% trans "Guests" %}', '{% trans "Interests" %}', '{% trans "Whats Included" %}', '{% trans "Extras" %}', '{% trans "Contact" %}', '{% trans "Done!" %}'],
		sectionsColor: '#f7f7f7',
		onLeave: function(index, nextIndex, direction) {
		}
	});
  
  // Init budget tooltip
  var tooltipPlacement = $(window).width > 864 ? 'right' : 'top';
  $('#budget-mount').tooltip({
    placement: 'right',
    trigger: 'manual',
    template: '\
      <div class="tooltip" role="tooltip"> \
        <div class="tooltip-arrow"></div> \
        <div class="tooltip-inner" id="budget"></div> \
        <div class="tooltip-extra" id="budget-tip"></div> \
      </div> \
    '
  });

	// Show page when init is done
	$('.loading').fadeOut('slow');

	// Bind click events
	$('#start-btn').on('click', function() {
		$.fn.fullpage.moveSectionDown();
	});
  $('.next-btn').on('click', function() {
    $.fn.fullpage.moveSectionDown();
  });

	$('.city').on('click', function() {
		var $this = $(this);
		$this.hasClass('selected') ? $this.removeClass('selected') : $this.addClass('selected');
		updateCities();
	});

	$('.interest').on('click', function() {
		$this = $(this);
    var $icon = $this.children('.glyphicon');
		$this.hasClass('selected') ? $this.removeClass('selected') : $this.addClass('selected');
    $icon.hasClass('glyphicon-plus') ? $icon.addClass('glyphicon-ok').removeClass('glyphicon-plus') : $icon.addClass('glyphicon-plus').removeClass('glyphicon-ok');
		updateInterests();
	});
  
  $('#whats-included').children('.form-inline').each(function() {
    var $field = $(this);
    var $input = $field.children('input');
    var options = $field.children('.option');
    options.each(function() {
      var $option = $(this);
      $option.click(function() {
        options.each(function() {
          $(this).removeClass('selected');
        });
        $option.addClass('selected');
        $input.val($option.text()).trigger('change');
        updateBudget();
      });
    });
  });

	$('#submit-btn').on('click', function() {
		if (validateForm()) {
			$.ajax({
					url: '/itinerary/request/',
					type: 'POST',
					data: {
						csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']")[0].value,
						destinations: $("#id_destinations").val(),
						start_date: $("#id_start_date").val(),
						end_date: $("#id_end_date").val(),
						guests_adults: $("#id_guests_adults").val(),
						guests_children: $("#id_guests_children").val(),
						guests_infants: $("#id_guests_infants").val(),
						interests: $("#id_interests").val(),
						accommodation: $("#accommodation").val(),
						car_driver: $("#car-driver").val(),
						national_flight: $("#national-flight").val(),
            airport_transfer: $("#airport-transfer").val(),
						service_language: $("#service-language").val(),
						requirements: $("#id_requirements").val(),
						name: $("#id_name").val(),
						wechat: $("#id_wechat").val(),
						email: $("#id_email").val(),
						mobile: $("#id_mobile").val(),
						budget : $('#budget').text()
					}
				})
				.done(function() {
					$('#success-page').html(
              '<h1>{% trans "Your request has been submitted!" %}</h1><h2>{% trans "Please keep an eye on our phone call within 4 hours. We will call you between 9am - 9pm Beijing time." %}</h2>'
					);
					$('#fp-nav').fadeOut();
					$('#status-bar').slideDown();
				})
				.fail(function() {
          $('#succes-page').find('h1').text('{% trans "There was an error with sending your request" %}');
          $('#success-page').find('h2').text('{% trans "Please try again later" %}');
				});
		}
		$(this).removeAttr('disabled').html('Submit');
	});

  // Bind change events
  $('#id_destinations').change(function() {
    $('#city-section').find('.next-btn').attr('style', 'display:block');
  });
  $('#id_interests').change(function() {
    $('#interests-section').find('.next-btn').attr('style', 'display:block');
  });
  $('#car-driver').change(function() {
    if($('#airport-transfer').val() && $('#national-flight').val() && $('#service-language').val() && $('#accommodation').val()) {
      $('#whats-included').find('.next-btn').attr('style', 'display:block');
    }
  });
  $('#accommodation').change(function() {
    if($('#airport-transfer').val() && $('#national-flight').val() && $('#service-language').val() && $('#car-driver').val()) {
      $('#whats-included').find('.next-btn').attr('style', 'display:block');
    }
  });
  $('#national-flight').change(function() {
    if($('#airport-transfer').val() && $('#accommodation').val() && $('#service-language').val() && $('#car-driver').val()) {
      $('#whats-included').find('.next-btn').attr('style', 'display:block');
    }
  });
  $('#airport-transfer').change(function() {
    if($('#national-flight').val() && $('#accommodation').val() && $('#service-language').val() && $('#car-driver').val()) {
      $('#whats-included').find('.next-btn').attr('style', 'display:block');
    }
  });
  $('#service-language').change(function() {
    if($('#airport-transfer').val() && $('#accommodation').val() && $('#national-flight').val() && $('#car-driver').val()) {
      $('#whats-included').find('.next-btn').attr('style', 'display:block');
    }
  });
  $('#id_name').change(function() {
    if ($('#id_email').val() && $('#id_wechat').val() && $('#id_mobile').val()) {
      $('#contact-section').find('.next-btn').attr('style', 'display:block');
    }
  });
  $('#id_email').change(function() {
    if ($('#id_name').val() && $('#id_wechat').val() && $('#id_mobile').val()) {
      $('#contact-section').find('.next-btn').attr('style', 'display:block');
    }
  });
  $('#id_wechat').change(function() {
    if ($('#id_name').val() && $('#id_email').val() && $('#id_mobile').val()) {
      $('#contact-section').find('.next-btn').attr('style', 'display:block');
    }
  });
  $('#id_mobile').change(function() {
    if ($('#id_name').val() && $('#id_email').val() && $('#id_wechat').val()) {
      $('#contact-section').find('.next-btn').attr('style', 'display:block');
    }
  });
})

function updateBudget() {
  var currencyConversion = 1;
  if (window.location.pathname.indexOf("/cn") > -1 || window.location.href.indexOf(".cn") > -1) {
    currencyConversion = 4.67;
  }
	var guests = parseInt($('#id_guests_adults').val()) + parseInt($("#id_guests_children").val()) + parseInt($("#id_guests_infants").val());
	var days = moment($('#id_end_date').val()).diff(moment($('#id_start_date').val()), 'days');
	var cities = $('#id_destinations').val().split(',').length;
	var min = 0;
	var max = 0;
  var accomPrice = 0;
  var flightPrice = 0;

  // Check if date fields entered:
  if (isNaN(days)) {
    $('#budget-mount').tooltip('show');
    return;
  }

	// car+driver
	switch ($('#car-driver').val()) {
		case '':
			break;
		case 'none':
			break;
		case 'infrequent':
			if (guests < 5) {
				min += 167;
				max += 400;
			} else if (guests < 8) {
				min += 267;
				max += 500;
			} else {
				min += 333;
				max += 667;
			}
			break;
		case 'frequent':
			if (guests < 5) {
				min += 250;
				max += 600;
			} else if (guests < 8) {
				min += 400;
				max += 750;
			} else {
				min += 500;
				max += 1000;
			}
			break;
		case 'whole trip':
			if (guests < 5) {
				min += 500;
				max += 1200;
			} else if (guests < 8) {
				min += 800;
				max += 1500;
			} else {
				min += 1000;
				max += 2000;
			}
			break;
	}

	// accommodation
	switch ($('#accommodation').val()) {
		case '':
			break;
		case 'none':
			break;
		case '3 star':
			min += (Math.round(guests / 2) * 150);
			max += (Math.round(guests / 2) * 300);
      accomPrice = 150;
			break;
		case '4 star':
			min += (Math.round(guests / 2) * 200);
			max += (Math.round(guests / 2) * 400);
      accomPrice = 200;
			break;
		case '5 star':
			min += (Math.round(guests / 2) * 300);
			max += (Math.round(guests / 2) * 600);
      accomPrice = 300;
			break;
	}

	// service language
	switch ($('#service-language').val()) {
		case '':
			break;
		case 'english':
			break;
		case 'chinese':
			min += 50;
			max += 50;
	}

	//// PER DAY ABOVE
	min *= days;
	max *= days;
	//// FOR WHOLE TRIP BELOW

	// national flights
	switch ($('#national-flight').val()) {
		case '':
			break;
		case 'none':
			break;
		case 'economy':
			min += ((cities - 1) * guests * 200);
			max += ((cities - 1) * guests * 400);
      flightPrice = 200;
	}

	// airport transfer
	switch ($('#airport-transfer').val()) {
		case '':
			break;
		case 'none':
			break;
		case 'yes':
			min += (cities * 200);
			max += (cities * 200);
	}

  if (min < 1000) {
    $('#budget-mount').attr('data-original-title', '{% trans "Our custom itinerary service starts from $1000"%}');
    $('#budget').attr('style', 'background-color:#FF8F93;');
    $('.tooltip-arrow').attr('style', 'border-right-color:#FF8F93');
  }
	else {
    $('#budget-mount').attr('data-original-title', '{% trans "Estimated cost: $" %}' + Math.round((min/guests)*currencyConversion) + '+ {% trans "per person ($" %}' + min*currencyConversion + '+ {% trans "in total" %})');
    $('#budget').removeAttr('style');
    $('.tooltip-arrow').removeAttr('style');
	}
  if (guests < 6) {
    var savings = Math.round((min/guests)*currencyConversion) - Math.round(((min/(guests+2))+(accomPrice/2)+(flightPrice))*currencyConversion);
    if (savings > 0) {
      $('#budget-tip').attr('style', 'display:inline-block;').text("{% trans 'Save $' %}" + (savings*2) + " {% trans 'by adding 2 extra people!' %}");
    } else {
      $('#budget-tip').attr('style', 'display:inline-block;').text("{% trans 'Add 2 extra people for only $' %}" + Math.abs(savings*2) + "!");
    }
  } else {
    $('#budget-tip').removeAttr('style');
  }
  $('#budget-mount').tooltip('show');
}

function updateCities() {
	var selectedCities = $('.city.selected').map(function() {
		return $(this).text();
	}).get();
	$('#id_destinations').val(selectedCities.join(', ')).trigger('change');
}

function updateInterests() {
	var selectedInterests = $('.interest.selected').map(function() {
		return $(this).text();
	}).get();
	$('#id_interests').val(selectedInterests.join(', ')).trigger('change');
}

function validateForm() {
	if ($('#id_destinations').val() && $('#id_start_date').val() && $('#id_guests_adults').val() && $('#id_name').val() && $('#id_mobile').val() && $('#id_email').val()) {
		return true;
	} else {
		$('.asterisk').addClass('animated shake').css({'color': 'red'});
		var wait = window.setTimeout( function(){
            $('.asterisk').removeClass('animated shake')}, 1000
        );
		return false;
	}
}
</script>
{% endblock %}
