{% extends "app/layout.html" %}
{% load staticfiles %}
{% load mathfilters %}
{% load i18n %}

{% block head %}
    <title>{% trans 'Itinerary tool' %}</title>
    <link href="{% static 'experiences/content/itinerary-tool.css' %}" rel="stylesheet"/>
{% endblock %}

{% block content %}
    {% csrf_token %}
    <div>
        <input id="itinerary_day_1" type="text" class="itinerary_item" city="Melbourne" category="products" style="width:300px;height:30px;">
        <textarea id="hint" type="text" style="width:600px;height:300px;margin-top:60px;"></textarea>
    </div>
    <div id="root" class="container"></div>
{% endblock %}

{% block scripts %}
    <script src="{% static 'experiences/scripts/itinerary-tool.min.js' %}"></script>
    <script type="text/javascript">
    var timer;
    function searchExperience(e){ 
        var title = $("#"+e.target.id).val();
        var city = $("#"+e.target.id).attr("city");
        var category = $("#"+e.target.id).attr("category");
        if(title == null || city == null || title.length == 0 || city.length == 0)
        {
            return;
        }
        $.ajax({
                url: '/search_text/',
                type: "POST",
                async: true,
                data : {
                            csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']")[0].value,
                            city: city,
                            title: title,
                            category: category,
                        }
            }).done(function(data){
                var suggestions_exp = "Experiences:\n";
                for(var i=0; i < data["experiences"].length; i++)
                {
                    suggestions_exp += data["experiences"][i]["title"] + "\n";
                }
                var suggestions_iti = "\nDaily itineraries:\n";
                for(i=0; i < data["daily_itineraries"].length; i++)
                {
                    for(var j=0; j < data["daily_itineraries"][i]["experiences"].length; j++)
                    {
                        suggestions_iti += data["daily_itineraries"][i]["experiences"][j]["title"] + " ";
                    }
                    suggestions_iti += "\n";
                }
                $("#hint").text(suggestions_exp + suggestions_iti);

            }).fail(function(jqXHR, textStatus) {
                $("#hint").text("error");
            });
    }

    $(document).ready(function()
    {
        $(".itinerary_item").on('keyup', function(e){
            if(timer) {
                clearTimeout(timer);
                timer=null;
            }
            timer = setTimeout(function() {searchExperience(e)}, 1000); 
        });
    });
    </script>
{% endblock %}
