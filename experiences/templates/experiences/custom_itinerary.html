{% extends "app/layout.html" %}
{% load staticfiles %}
{% load mathfilters %}
{% load i18n %}

{% block head %}
    <title>{% trans 'Custom Itinerary' %}</title>
    <link href="{% static 'experiences/content/search.css' %}" rel="stylesheet">
    <link href="{% static 'bootstrap3_datetime/css/bootstrap-datetimepicker.min.css' %}" type="text/css" media="all" rel="stylesheet" />
    <link href="{% static 'experiences/content/custom-itinerary.css' %}" rel="stylesheet"/>
{% endblock %}

{% block content %}
<form id="itinerary_form" action="" method="post" target="_blank">
  {% csrf_token %}
  <div style="display:none;">
  <!-- TODO -->
    {{form.note}}
    {{form.description}}
    {{form.city}}

    {{form.language}}
    {{form.sort}}
    {{form.age_limit}}
    {{form.tags}}
    {{form.all_tags}}
    {{form.itinerary_string}}

    <!-- Done, but needs to be hidden -->
    {{form.adult_number}}
    {{form.children_number}}
    {{form.end_datetime}}
    {{form.cities_string}}
  </div>
  <!-- Top search bar -->
  <div class="basic-search">
    <div class="container">
      <div class="row">
        <div class="form-inline">
          <h3 class="form-header">{% trans "Title" %}</h3>
          {{form.title}}
        </div>
        <div class="form-inline">
          <h3 class="form-header">{% trans "Start date" %}</h3>
          <div class="start-date">
            {{form.start_datetime}}
          </div>
        </div>
        <div class="form-inline right-group" style="margin-right:0;">
          <h3 class="form-header">{% trans "Group size" %}</h3>
          <button id="add-adults" type="button" class="btn btn-grey"data-container="body" data-toggle="popover" data-placement="bottom" data-html="true" data-content='
            <div class="form-goup">
              <select id="guest-num-select" class="form-control">
                {% for i in guest_num_range %}
                {% if forloop.counter == adult_number %}
                <option value={{forloop.counter}} selected>{{forloop.counter}}</option>
                {% else %}
                <option value={{forloop.counter}}>{{forloop.counter}}</option>
                {% endif %}
                {% endfor %}
                <option value="150">150</option>
              </select>
            </div>
              <button type="button" class="btn btn-primary" id="submit-add-adults">Update</button>
              <button type="button" class="btn btn-default" style="margin-right:0;" id="cancel-add-adults">Cancel</button>
            '>Adults <span class="badge" id="num-adults">{% if adult_number %}{{ adult_number }}{% else %}1{% endif %}</span>
          </button>
          <button id="add-kids" type="button" class="btn btn-default"data-container="body" data-toggle="popover" data-placement="bottom" data-html="true" data-content="
            <div class='form-goup'>
              <select id='kid-num-select' class='form-control'>
                {% for i in "0123456789" %}
                {% if forloop.counter0 == children_number %}
                <option value={{forloop.counter0}} selected>{{forloop.counter0}}</option>
                {% else %}
                <option value={{forloop.counter0}}>{{forloop.counter0}}</option>
                {% endif %}
                {% endfor %}
              </select>
            </div>
              <button type='button' class='btn btn-primary' id='submit-add-kids'>Update</button>
              <button type='button' class='btn btn-default' id='cancel-add-kids' style='margin-right:0;' onclick='$(&quot;#add-kids&quot;).popover(&quot;hide&quot;);'>Cancel</button>
            ">Kids (2-12 yo) <span class="badge" id="num-kids">{% if children_number %}{{ children_number }}{% else %}0{% endif %}</span>
          </button>
        </div>
      </div>
      <div class="row">
        <div class="form-inline">
          <h3 class="form-header">{% trans "Location" %}</h3>

          <button id="add-city" type="button" class="btn btn-default" data-container="body" data-toggle="popover" data-placement="bottom" data-html="true" data-content="
            <div class='form-group'>
                <p>{% trans 'Location' %}</p>
                <select id='new_city' class='form-control'>
                    {% for tuple in location %}
                    <option value='{{tuple.0}}'>{{tuple.0}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class='form-goup'>
                <p>{% trans 'Duration' %}</p>
                <select id='new_duration' class='form-control'>
                    {% for i in "0123456789" %}
                    <option value={{i|mul:2|add:1}}>{{i|mul:2|add:1}}{% trans ' Day' %}</option>
                    <option value={{i|mul:2|add:2}}>{{i|mul:2|add:2}}{% trans ' Day' %}</option>
                    {% endfor %}
                </select>
            </div>
              <button class='btn btn-primary' onclick='add_new_city();$(&quot;#add-city&quot;).popover(&quot;hide&quot;);'>{% trans 'Add' %}</button>
              <button class='btn btn-default' style='margin-right:0;' onclick='$(&quot;#add-city&quot;).popover(&quot;hide&quot;);'>{% trans 'Cancel' %}</button>
            ">+ {% trans 'Add City' %}
          </button>
        </div>
        <div class="form-inline right-group">
          <h3 class="form-header">Web</h3>
          <button {% if existing_itinerary.status == "paid" %}disabled="disabled"{% endif %} id="button_ready" name="ready" class="btn btn-sm btn-default">$</button>
          <button {% if existing_itinerary.status == "paid" %}disabled="disabled"{% endif %} id="button_draft" name="draft" class="btn btn-sm btn-default"><img src="{% static 'icon/locked.svg' %}" width="18" height="18"></button>
          <h3 class="form-header">PDF</h3>
          <button type="button" id="" class="btn btn-sm btn-default">$</button>
          <button type="button" id="" class="btn btn-sm btn-default"><img src="{% static 'icon/locked.svg' %}" width="18" height="18"></button>
          <!-- TODO -->
          <input class="btn btn-default" id="itinerary_search" type="hidden" value="{% trans "Search" %}" name="Search">
        </div>
      </div>
    </div>
  </div>

  <div class="loading"><img src="{% static 'experiences/img/loading.svg' %}" width="32px" height="32px" class="ajax-loader"/></div>

  <div class="container">
    <div class="row">
      <div class="col-sm-6">
        <!-- Left section -->
        <div class="section">
          <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#product" aria-controls="product" role="tab" data-toggle="tab"><img src="{% static 'experiences/img/hot-56.svg' %}"></a></li>
            <li role="presentation"><a href="#experience" aria-controls="experience" role="tab" data-toggle="tab"><img src="{% static 'experiences/img/profile.svg' %}"></a></li>
            <li role="presentation"><a href="#flight" aria-controls="flight" role="tab" data-toggle="tab"><img src="{% static 'experiences/img/flight.svg' %}"></a></li>
            <li role="presentation"><a href="#transfer" aria-controls="transfer" role="tab" data-toggle="tab"><img src="{% static 'experiences/img/transfer.svg' %}"></a></li>
            <li role="presentation"><a href="#accommodation" aria-controls="accommodation" role="tab" data-toggle="tab"><img src="{% static 'experiences/img/accommodation.svg' %}"></a></li>
            <li role="presentation"><a href="#restaurant" aria-controls="restaurant" role="tab" data-toggle="tab"><img src="{% static 'experiences/img/restaurant.svg' %}"></a></li>
            <li role="presentation"><a href="#suggestion" aria-controls="suggestion" role="tab" data-toggle="tab"><img src="{% static 'experiences/img/itinerary.svg' %}"></a></li>
            <li role="presentation"><a href="#pricing" aria-controls="pricing" role="tab" data-toggle="tab"><img src="{% static 'experiences/img/price.svg' %}"></a></li>
          </ul>
          <!-- Tab panes -->
          <div class="tab-content">
          </div>
        </div>
      </div>
      <div class="col-sm-6">
        <!-- Right section -->
        <div id="right_section" class="section" style="overflow:scroll; height:78vh;">
          <h1 class="section-heading">Itinerary</h1>
          <h2 class="price-line">{{request.session.dollar_sign}}{{request.session.custom_currency}} <label id="price-pp">0</label> {% trans "per person (Total of "%}{{request.session.dollar_sign}}{{request.session.custom_currency}} <label id="price-tt">0</label>)</h2>
          <div id="sortable">
          {% for city in existing_itinerary %}
          <div class="city-sortable">
            <div id="city-title-{{forloop.counter0}}" class="section-box-add" onclick="$('.collapse').collapse('hide'); $('#city-collapse-{{forloop.counter0}}').collapse('show');update_left_section('{{city.city}}');" city="{{city.city}}">
              <span class="add-sign">+</span>
              <p id="city-title-p-{{forloop.counter0}}">{{city.city}} <span class="badge">{{city.dates|length}}{% trans ' Day(s)' %}</span></p>
            </div>
            <div class="collapse" id="city-collapse-{{forloop.counter0}}">
              {% for date, experiences in city.dates.items %}
              <div id="city-collapse-{{forloop.parentloop.counter0}}-day-{{forloop.counter}}" class="section-box">
                <p>{% trans 'Day' %} {{forloop.counter}}</p>
                <div class="column">
                  {% for experience in experiences %}
                  <div class="experience_id_{{experience.id}} exp-box-sm added {% if experience.type == 'PrivateProduct' or experience.type == 'PublicProduct' or experience.type == 'PRIVATE' or experience.type == 'NONPRIVATE' %}experience{% endif %}">
                    <div class='exp-img'>
                        <img src='{{MEDIA_URL}}thumbnails/experiences/experience{{experience.id}}_1.jpg' alt="" style='height:inherit;width:inherit;'/>
                    </div>
                    <div class='exp-info'>
                        <h3><a href="{{GEO_POSTFIX}}experience/{{experience.id}}">{{experience.title}}</a></h3>
                        <p>{{experience.description|escapejs|slice:"0:16"}}</p>
                        {% if experience.type == 'PrivateProduct' or experience.type == 'PublicProduct' or experience.type == 'PRIVATE' or experience.type == 'NONPRIVATE' %}
                        <p style="display:none;">{{experience.duration}} {% trans 'hr(s)' %} &middot;
                            {%if experience.language == 'english;mandarin;'%}English / 中文{%else%}English{%endif%} &middot;
                            {% if experience.type == 'PRIVATE' or experience.type == 'PrivateProduct'%}<strong>{% trans 'Private' %}</strong>{% endif %}</p>
                        {% else %}
                        <p class='exp-edit' style="display:none;">
                          <a type="button" onclick="edit_item({{experience.id}}, '{{experience.type}}');">{% trans "Edit" %}</a>
                          &middot;
                          <a type="button" onclick="duplicate_item({{experience.id}}, '{{experience.type}}');">{% trans "Duplicate" %}</a>
                          &middot;
                          <a type="button" onclick="delete_item({{experience.id}});">{% trans "Delete" %}</a>
                        </p>
                        <label style="display:none;">{{experience.notes}}</label>
                        {% endif %}
                        <div class="whats-included" style="display:block;">
                          {% if experience.type == 'PrivateProduct' or experience.type == 'PublicProduct' or experience.type == 'PRIVATE' or experience.type == 'NONPRIVATE' %}
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Car driver"><img src="{% static 'experiences/img/cardriver.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Activities"><img src="{% static 'experiences/img/hot-56.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Breakfast"><img src="{% static 'experiences/img/breakfast.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Lunch"><img src="{% static 'experiences/img/lunch.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Dinner"><img src="{% static 'experiences/img/dinner.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Bus"><img src="{% static 'experiences/img/bus.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Ferry"><img src="{% static 'experiences/img/boat.svg' %}"></button>
                          {% elif experience.type == 'Flight' %}
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Flight"><img src="{% static 'experiences/img/flight.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Breakfast"><img src="{% static 'experiences/img/breakfast.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Lunch"><img src="{% static 'experiences/img/lunch.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Dinner"><img src="{% static 'experiences/img/dinner.svg' %}"></button>
                          {% elif experience.type == 'Transfer' %}
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Airport pickup"><img src="{% static 'experiences/img/airportpickup.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Airport dropoff"><img src="{% static 'experiences/img/airportdropoff.svg' %}"></button>
                          {% elif experience.type == 'Accommodation' %}
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Accommodation"><img src="{% static 'experiences/img/accommodation.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Breakfast"><img src="{% static 'experiences/img/breakfast.svg' %}"></button>
                          {% elif experience.type == 'Restaurant' %}
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Breakfast"><img src="{% static 'experiences/img/breakfast.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Lunch"><img src="{% static 'experiences/img/lunch.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Dinner"><img src="{% static 'experiences/img/dinner.svg' %}"></button>
                          {% elif experience.type == 'Suggestion' %}
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Car driver"><img src="{% static 'experiences/img/cardriver.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Breakfast"><img src="{% static 'experiences/img/breakfast.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Lunch"><img src="{% static 'experiences/img/lunch.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Dinner"><img src="{% static 'experiences/img/dinner.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Accommodation"><img src="{% static 'experiences/img/accommodation.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Bus"><img src="{% static 'experiences/img/bus.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Ferry"><img src="{% static 'experiences/img/boat.svg' %}"></button>
                          <button type="button" class="btn btn-default whats-included-btn" data-toggle="button" aria-pressed="false" autocomplete="off" value="Activities"><img src="{% static 'experiences/img/hot-56.svg' %}"></button>
                          {% endif %}
                        </div>
                    </div>
                    {% if experience.type == 'PrivateProduct' or experience.type == 'PublicProduct' or experience.type == 'PRIVATE' or experience.type == 'NONPRIVATE' %}
                    <div class='exp-price'>
                        <p>{{experience.dollarsign}}{{experience.currency}}</p>
                        <h2 style="display:none;" class="fixed-price">0</h2><h2 class="price">{{experience.price|floatformat:"0"}}</h2>
                        <p>{% trans 'per person' %}</p>
                    </div>
                    {% else %}
                    <div class="exp-price">
                      <div class="container-fluid">
                        <span class="inline-text fixed-price-min">{{experience.fixed_price_min|floatformat:"0"}}</span><div class="slider slider-price-base"></div><span class="inline-text fixed-price-max">{{experience.fixed_price_max|floatformat:"0"}}</span>
                        <p>
                          <input type="text" class="fixed-price" readonly>
                          <label>{% trans 'base' %}</label>
                        </p>
                      </div>
                      <div class="container-fluid">
                        <span class="inline-text price-min">{{experience.price_min|floatformat:"0"}}</span><div class="slider slider-price-pp"></div><span class="inline-text price-max">{{experience.price_max|floatformat:"0"}}</span>
                        <p>
                          <input type="text" class="price" readonly>
                          <label>{% trans 'pp' %}</label>
                        </p>
                      </div>
                    </div>
                    {% endif %}
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Warning popups -->
<div class="modal fade" id="warning-delete-location" tabindex="-1" role="dialog" aria-labelledby="warning">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body">
        Are you sure you want to delete this location? Everything you have planned for that location will be deleted.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="confirm-delete">Delete</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="warning-duration-location" tabindex="-1" role="dialog" aria-labelledby="warning">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body">
        Are you sure you want to reduce the duration of this location? Everything you have planned for the removed days will be deleted.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="confirm-duration-location">Go ahead</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="warning-duration-trip" tabindex="-1" role="dialog" aria-labelledby="warning">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body">
        Are you sure you want to reduce the duration of the entire trip? Any location that falls outside of the duration will be deleted.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="confirm-duration-trip">Go ahead</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="{% static 'bootstrap3_datetime/js/moment.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'bootstrap3_datetime/js/bootstrap-datetimepicker.min.js' %}"></script>
    {%if LANGUAGE == "zh-CN"%}
    <script type="text/javascript" src="{% static 'bootstrap3_datetime/js/locales/bootstrap-datetimepicker.zh-CN.js' %}"></script>
    {%endif%}
    <script type="text/javascript" src="{% static 'experiences/scripts/custom_itinerary.js' %}"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"></script>
    <script type="text/javascript">
    cities = {{location_keys|safe}};

    $(document).ready(function()
    {
        $(".loading").hide();
        if ($("#id_title").val() == "") {
          $("#id_title").val("新路线");
        }
        if ($("#id_start_datetime").val() == "") {
          var d = new Date();
          d.setDate(d.getDate()+14);
          $("#id_start_datetime").val(d.toString('yyyy-M-dd'));
        }

        $("#itinerary_search").click(function(e){
            e.preventDefault();
            if(!set_data_before_submit())
            {
                alert("Please fill all fields");
                return;
            }
            $(".loading").show();

            $.ajax({
                url : '{{GEO_POSTFIX}}itinerary/',
                type: "POST",
                async: true,
                timeout: 60000,
                data : {
                            csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']")[0].value,
                            city: $("#id_city").val(),
                            start_datetime: $("#id_start_datetime").val(),
                            end_datetime: $("#id_end_datetime").val(),
                            adult_number: $("#id_adult_number").val(),
                            children_number: $("#id_children_number").val(),
                            language: $("#id_language").val(),
                            Search: "Search",
                            tags: $("#id_tags").val(),
                            all_tags: $("#id_all_tags").val(),
                            sort: $("#id_sort").val(),
                            age_limit: $("#id_age_limit").val()
                        }
            }).done(function(data){
                            $('.tab-content').html(data);
                            $('.nav-tabs').children().removeClass();
                            $($('.nav-tabs').children()[0]).addClass("active");
                            init_drag(); // Initialize draggable elements
                            filter_experiences(); // Initialize search filter
                            update_dates();
                            update_price_title();
                            $(".loading").hide();
            }).fail(function(jqXHR, textStatus) {
                            $(".loading").hide();
                            if(textStatus === 'timeout')
                            {
                                alert('Request timeout');
                            }
                            else
                            {
                                $('.tab-content').text("Sorry but there was an error.");
                            }
            });
        });

        $("#button_draft").click(function(e){
            if(!set_data_before_submit())
            {
                e.preventDefault();
                alert("Please fill all fields");
                return;
            }
            set_itinerary_string();
            if($("#id_itinerary_string").val().length <= 2)
            {
                e.preventDefault();
                alert("{% trans "Empty itinerary" %}");
            }
        });

        $("#button_ready").click(function(e){
            if(!set_data_before_submit())
            {
                e.preventDefault();
                alert("Please fill all fields");
                return;
            }
            set_itinerary_string();
            if($("#id_itinerary_string").val().length <= 2)
            {
                e.preventDefault();
                alert("{% trans "Empty itinerary" %}");
            }
        });

        // Date field
        if (window.location.pathname.indexOf("/cn") > -1 || window.location.href.indexOf(".cn") > -1) {
            $(function () {
                $("#id_start_datetime").datetimepicker({
                    format: 'YYYY-MM-DD', locale: 'zh-CN'
                });
            });
        }
        else {
            $(function () {
                $("#id_start_datetime").datetimepicker({
                    format: 'YYYY-MM-DD'
                });
            });
        }

        $("#id_start_datetime").focusout(function () {
            if ($("#id_start_datetime").val() != "" && $("#id_end_datetime").val() != "") {
                $("#itinerary_search").click();
            }
        });

        //set initial values if in the editing mode
        {% for city in existing_itinerary %}
        // add a new button for the city
        var city = "{{city.city}}";
        var city_name = "{{city.city}}";
        var duration = {{ city.dates|length }};
        var i = {{forloop.counter0}};
        var new_city = construct_data_content(i, cities, city, city, duration);
        $(new_city).insertBefore($("#add-city"));
        // Initialise popovers
        $('[data-toggle="popover"]').popover();
        {% if forloop.last %}
        $("#itinerary_search").click();
        update_price_title();
        {% endif %}
        {% endfor %}

        $(document).on("click", "#submit-add-kids", function() {
            update_kids();
        });

        $("#right_section").find(".exp-box-sm").each(function() {
          init_slider($(this));
          $(this).find(".whats-included").show();
        });
    })

    function construct_data_content(i, cities, city, city_name, duration)
    {
        var new_city =
                "<button id=\"button_city_" + i + "\" type=\"button\" class=\"btn btn-grey\" data-container=\"body\" data-toggle=\"popover\" data-placement=\"bottom\" data-html=\"true\" data-content=\"" +
                    "<div class='form-group'>" +
                        "<p>{% trans 'Location' %}</p>" +
                        "<select id='city_list_" + i + "' class='form-control'>";

        for(var c=0;c<cities.length;c++)
        {
            if(cities[c] == city)
            {
                new_city += "<option value='" + cities[c] + "' selected>" + cities[c] + "</option>";
            }
            else
            {
                new_city += "<option value='" + cities[c] + "'>" + cities[c] + "</option>";
            }

        }
        new_city +=     "</select>" +
                    "</div>" +
                    "<div class='form-goup'>" +
                        "<p>{% trans 'Duration' %}</p>" +
                        "<select id='duration_list_" + i +"' class='form-control'>";

        for(var d=1;d<=20;d++)
        {
            if(d == parseInt(duration))
            {
                new_city += "<option value=" + d + " selected>" + d + "{% trans ' Day' %}</option>";
            }
            else
            {
                new_city += "<option value=" + d + ">" + d + "{% trans ' Day' %}</option>";
            }
        }
        new_city +=
                        "</select>" +
                    "</div>" +
                    "<button id='update_city_" + i + "' class='btn btn-primary' onclick='update_city(" + i + ")'>{% trans 'Update' %}</button>" +
                    "<button class='btn btn-default' style='margin-right:0;' onclick='$(&quot;#button_city_" + i + "&quot;).popover(&quot;hide&quot;);'>{% trans 'Cancel' %}</button>" +
                    "<button id='delete_city_" + i + "' class='btn btn-danger' onclick='delete_city(" + i + ")'>{% trans 'Delete Location' %}</button>" +
                    "\" city='" + city + "' duration=" + duration + ">" + city_name + " <span class=\"badge\">" + duration + "</span>" +
                "</button>";
        return new_city;
    }

    function update_left_section(city)
    {
        //the left section: only show the experiences in the given city
        for(var i=0;i<cities.length;i++)
        {
            if(cities[i]==city)
            {
                $(".city_" + cities[i]).show();
                $(".flight_" + cities[i]).show();
                $(".transfer_" + cities[i]).show();
                $(".accommodation_" + cities[i]).show();
                $(".restaurant_" + cities[i]).show();
                $(".suggestion_" + cities[i]).show();
            }
            else
            {
                $(".city_" + cities[i]).hide();
                $(".flight_" + cities[i]).hide();
                $(".transfer_" + cities[i]).hide();
                $(".accommodation_" + cities[i]).hide();
                $(".restaurant_" + cities[i]).hide();
                $(".suggestion_" + cities[i]).hide();
            }
        }
        var type = ["flight", "transfer", "accommodation", "restaurant", "suggestion", "pricing"];
        for(i=0;i<type.length;i++)
        {
            $("#"+type[i]+"-location").val(city);
        }
    }

    function add_new_city()
    {
        var i=-1;
        //the last city was inserted before $("#add-city")
        //but the user may have changed the order of cities
        //if($("#add-city").prev().attr('id') && $("#add-city").prev().attr('id').indexOf("button_city_") === 0)
        //{
        //    var id = $("#add-city").prev().attr('id').split("_");
        //    i = parseInt(id[id.length-1]);
        //}
        var k=0;
        for(k=0;k<10;k++)
        {
            if($("#button_city_"+k).length > 0)
            {
                i++;

                if(i>=9)
                {
                    return;
                }
            }
        }
        i += 1;
        var city = $("#new_city").val();
        var city_name = $("#new_city option:selected").text();
        var duration = $("#new_duration").val();

        //add a new button for the city
        var new_city = construct_data_content(i, cities, city, city_name, duration);
        $(new_city).insertBefore($("#add-city"));
        // Initialise popovers
        $('[data-toggle="popover"]').popover();

        //add a new item in the right section
        var new_item =
                    "<div class=\"city-sortable\">" +
                    "<div id=\"city-title-" + i + "\" class=\"section-box-add\" onclick=\"$('.collapse').collapse('hide'); $('#city-collapse-" + i + "').collapse('show');update_left_section('" + city + "');\" city=" + city + ">" +
                        "<span class=\"add-sign\">+</span>" +
                        "<p id=\"city-title-p-" + i + "\">" + city_name + " <span class=\"badge\">" + duration + "{% trans ' Day(s)' %}</span></p>" +
                    "</div>" +
                    "<div class=\"collapse\" id=\"city-collapse-" + i + "\">";
        for(var j=1;j<=duration;j++)
        {
            new_item +=
                        "<div id=\"city-collapse-" + i + "-day-" + j + "\" class=\"section-box\">" +
                            "<p>{% trans 'Day' %} " + j + "</p>" +
                            "<div class=\"column\">" +
                            "</div>" +
                        "</div>";
        }
        new_item += "</div></div>";
        $("#sortable").append(new_item);

        //reload data
        $("#itinerary_search").click();
    }

    function update_dates() {
      var startDate = $('#id_start_datetime').val();
      $('.section-box>p').each(function(index) {
        $(this).html("{% trans 'Day' %} " + (index+1) + " " + moment(startDate).add(index,'days').format('YYYY-MM-DD dddd'))
      })
    }

    function update_guests() {
      var guests = $("#guest-num-select").val();
      $("#add-adults")[0].innerHTML = "Adults" + " <span class=\"badge\" id=\"num-adults\">" + guests + "</span>";
      $("#id_adult_number").val(guests);
      $("#add-adults").popover("hide");
      $("#itinerary_search").click();
    }

    function update_kids() {
      var kids = $("#kid-num-select").val();
      $("#add-kids")[0].innerHTML = "Kids (2-12 yo) " + " <span class=\"badge\" id=\"num-kids\">" + kids + "</span>";
      $("#id_children_number").val(kids);
      $("#add-kids").popover("hide");
      $("#itinerary_search").click();
    }

    function update_city(i)
    {
        var city = $("#city_list_" + i).val();
        var city_name = $("#city_list_" + i + " option:selected").text();
        var duration = parseInt($("#duration_list_" + i).val());
        $("#button_city_" + i)[0].innerHTML = city_name + " <span class=\"badge\">" + duration + "</span>";
        $("#button_city_" + i).popover("hide");
        //update $("#button_city_" + i).attr("data-content")
        $("#button_city_" + i).replaceWith(construct_data_content(i, cities, city, city_name, duration));
        // Initialise popovers
        $('[data-toggle="popover"]').popover();

        $("#city-title-" + i).attr("onclick","$('.collapse').collapse('hide'); $('#city-collapse-" + i + "').collapse('show');update_left_section('" + city + "')");
        $("#city-title-" + i).attr("city",city);
        $("#city-title-p-" + i)[0].innerHTML = city_name + " <span class=\"badge\">" + duration + "{% trans ' Day(s)' %}</span>";
        for(var j=1;j<=10;j++)
        {
            if(j<=duration && $("#city-collapse-" + i + "-day-" + j).length == 0)
            {
                //add a new day
                var new_day =   "<div id=\"city-collapse-" + i + "-day-" + j + "\" class=\"section-box\">" +
                                    "<p>{% trans 'Day' %} " + j + "</p>" +
                                    "<div class=\"column\">" +
                                    "</div>" +
                                "</div>";
                $("#city-collapse-" + i).append(new_day);
            }
            else if(j>duration && $("#city-collapse-" + i + "-day-" + j).length > 0)
            {
                //delete the day
                $("#city-collapse-" + i + "-day-" + j).remove();
            }
        }

        //reload data
        $("#itinerary_search").click();
    }

    function delete_city(i)
    {
        $("#button_city_" + i).popover("hide");
        $("#warning-delete-location").modal("show");
        $("#confirm-delete").click(function() {
            //remove experiences in that city from the left section
            city = $("#button_city_" + i).attr("city");
            $(".city_" + city).remove();
            $("#button_city_" + i).remove();
            $("#city-title-" + i).parent().remove();
            //$("#city-title-" + i).remove();
            //$("#city-collapse-" + i).remove();
            $("#warning-delete-location").modal("hide");
        });
    }

    function set_data_before_submit()
    {
        var cities="";
        var cities_string = "";
        //the last city was inserted before $("#add-city"), there must be at least one city
        if(!($("#add-city").prev().attr('id') && $("#add-city").prev().attr('id').indexOf("button_city_") === 0))
        {
            //TODO
        }
        var id = $("#add-city").prev().attr('id');
        var number_city = 0;
        //users may switch the order of cities, so button_city_1 can be behind button_city_2
        while(id && id.indexOf("button_city_") === 0)
        {
            var id_split = id.split("_");
            var i = parseInt(id_split[id_split.length-1]);

            if($("#button_city_"+i).length > 0)
            {
              city = $("#button_city_"+i).attr("city");
              duration = $("#button_city_"+i).attr("duration");
              for(j=0;j<duration;j++) {
                cities_string = city + "," + cities_string;
              }
              //comment out the following line if availability is considered in the future
              duration = 1;
              for(j=0;j<duration;j++)
              {
                  cities = city + "," + cities;
              }
              number_city += 1;

            }

            id = $("#"+id).prev().attr('id');
        }
        cities = cities.substring(0,cities.length-1);
        $("#id_city").val(cities);
        $("#id_cities_string").val(cities_string);

        if(!$("#id_start_datetime").val())
        {
            return false;
        }

        var d = new Date($("#id_start_datetime").val());
        //d.setTime(d.getTime() + d.getTimezoneOffset()*60*1000);
        d.setDate(d.getDate()+number_city-1);
        $("#id_end_datetime").val(d.toString('yyyy-M-dd'));
        return true;
    }

    function set_itinerary_string()
    {
        var numAdults = parseInt($("#id_adult_number").val());
        var numChildren = parseInt($("#id_children_number").val());
        var numGuests = numAdults + numChildren;

        var cities = $("#sortable .section-box-add").map(function() {
          return $(this).attr("city");
        }).get();

        var itinerary = [];
        $("#sortable .section-box").each(function() {
          var $items = $(this).find(".exp-box-sm");
          var date = $(this).children()[0].innerHTML.split(" ")[2];
          var hour = 0;
          var hour_string = "00";
          if ($items) {
            $items.each(function() {
              var $item = $(this);
              var classes = $item.attr("class").split(" ");
              var id = classes[0].split("_");

              var fixedPrice = $item.find(".fixed-price").val();
              if (isNaN(parseFloat(fixedPrice))) {
                fixedPrice = $item.find(".fixed-price").text();
              }
              var price = $item.find(".price").val();
              if (isNaN(parseFloat(price))) {
                price = $item.find(".price").text();
              }

              var total_price;
              if (classes.indexOf('experience') > -1) {
                total_price = null;
              } else {
                total_price = (parseFloat(fixedPrice) + parseFloat(price) * numGuests);
              }

              var whats_included = "";
              $item.find(".whats-included-btn").each(function() {
                if ($(this).attr("aria-pressed") == "true") {
                  whats_included += $(this).attr("value") + ", ";
                }
              });

              hour += 1;
              if (hour < 10) {
                hour_string = "0" + hour;
              } else if (hour > 23) {
                hour_string = "23";
              } else {
                hour_string = "" + hour;
              }

              var tmp = $item.find(".exp-info")[0].firstElementChild

              var dict = {"id": id[id.length-1],
                          "title": tmp.innerText || tmp.textContent,
                          "date": date,
                          "time":hour_string+":00",
                          "total_price": total_price,
                          "whats_included": whats_included,
                          "adult_number": numAdults,
                          "children_number": numChildren};
              itinerary.push(dict);
            });
          }
        });

        $("#id_city").val(cities.join());
        $("#id_itinerary_string").val(JSON.stringify(itinerary));
    }

    // Make filter case un-sensitive
    jQuery.expr[':'].contains = function(a,i,m) {
      return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase())>=0;
    };

    // Filters experiences on search keyword
    function filter_experiences() {
      $(".search-keyword")
        .change(function() {
          var filter = $(this).val();
          if (filter) {
            $(".exp-box-sm").find("div.exp-info:not(:contains(\'" + filter + "\'))").parent().slideUp();
            $(".exp-box-sm").find("div.exp-info:contains(\'" + filter + "\')").parent().slideDown();
          } else {
            $(".exp-box-sm").slideDown();
          }
          return false;
        })
        .keyup(function() {
          $(this).change();
      });
    }

    function add_item(type) {
        var ids = ["title", "location", "fixed_price-min", "fixed_price-max", "price-min", "price-max", "fixed_price", "price", "details", "notes"];
        var value = "";
        var item = new FormData();
        var title = $("#" + type + "-title").val();
        var details = $("#" + type + "-details").val();
        var location = $("#" + type + "-location").val();
        var fixed_price_min = parseFloat($("#" + type + "-fixed_price-min").val());
        var fixed_price_max = parseFloat($("#" + type + "-fixed_price-max").val());
        var fixed_price =  (fixed_price_min + fixed_price_max)/2;
        var price_min = parseFloat($("#" + type + "-price-min").val());
        var price_max = parseFloat($("#" + type + "-price-max").val());
        var price = (price_min + price_max)/2;
        var notes = $("#" + type + "-notes").val();
        $("#" + type + "-fixed_price").val(fixed_price);
        $("#" + type + "-price").val(price);
        item.append("csrfmiddlewaretoken", $("[name='csrfmiddlewaretoken']")[0].value);
        item.append("Add", "Add");
        item.append("type", type);

        for (var i = 0, j = 0; i < ids.length; i++) {
            value = $("#" + type + "-" + ids[i]).val();
            if(value)
            {
                item.append([ids[i]], value);
                j++;
            }
        }
        if(j == 0)
        {
            alert("Fill at least one field");
            return;
        }
        if($("#"+type+"-photo")[0] && $("#"+type+"-photo")[0].files.length > 0)
        {
            file = $("#"+type+"-photo")[0].files[0];
            if(file.size > 2097152)
            {
                alert("{% trans "Image size exceeds the limit (2M)" %}");
                return;
            }
            if(file.type.indexOf("image/") < 0)
            {
                alert("{% trans "Invalid image type" %}");
                return;
            }
            item.append("file", file);
        }
        $(".loading").show();
        $.ajax({
            url: '{{GEO_POSTFIX}}itinerary/',
            type: "POST",
            async: true,
            data: item,
            processData: false,
            contentType: false
        }).done(function (data) {
                if(isNaN(parseFloat(fixed_price)))
                {
                    fixed_price = 0;
                }
                if(isNaN(parseFloat(price)))
                {
                    price = 0;
                }

                var new_item =  "<div class=\"experience_id_" + data.new_product_id + " exp-box-sm\">" +
                                  "<div class=\"exp-img\"><img src=\"{{MEDIA_URL}}thumbnails/experiences/experience" + data.new_product_id + "_1.jpg\" style=\"width:inherit;height:inherit;\"></div>" +
                                  "<div class=\"exp-info\">" +
                                    "<h3>" + title + "</h3>" +
                                    "<p>" + details + "</p>" +
                                    "<label style=\"display:none;\">" + notes + "</label>";

                new_item +=
                "<p class=\"exp-edit\">" +
                  "<a type=\"button\" onclick=\"edit_item(" + data.new_product_id + ", '" + type + "');\">{% trans "Edit" %}</a>" +
                  " &middot; " +
                  "<a type=\"button\" onclick=\"duplicate_item(" + data.new_product_id + ", '" + type + "');\">{% trans "Duplicate" %}</a>" +
                  " &middot; " +
                  "<a type=\"button\" onclick=\"delete_item(" + data.new_product_id + ", '" + type + "');\">{% trans "Delete" %}</a>" +
                "</p>" +
                "<div class=\"whats-included\">";

                if (type == 'PrivateProduct' || type == 'PublicProduct' || type == 'PRIVATE' || type == 'NONPRIVATE') {
                  new_item +=
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Car driver\"><img src=\"{% static 'experiences/img/cardriver.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Activities\"><img src=\"{% static 'experiences/img/hot-56.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Lunch\"><img src=\"{% static 'experiences/img/lunch.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Dinner\"><img src=\"{% static 'experiences/img/dinner.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Bus\"><img src=\"{% static 'experiences/img/bus.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Ferry\"><img src=\"{% static 'experiences/img/boat.svg' %}\"></button>";
                } else if (type == 'flight') {
                  new_item +=
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Flight\"><img src=\"{% static 'experiences/img/flight.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Lunch\"><img src=\"{% static 'experiences/img/lunch.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Dinner\"><img src=\"{% static 'experiences/img/dinner.svg' %}\"></button>";
                } else if (type == 'transfer') {
                  new_item +=
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Airport pickup\"><img src=\"{% static 'experiences/img/airportpickup.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Airport dropoff\"><img src=\"{% static 'experiences/img/airportdropoff.svg' %}\"></button>";
                } else if (type == 'accommodation') {
                  new_item +=
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Accommodation\"><img src=\"{% static 'experiences/img/accommodation.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>";
                } else if (type == 'restaurant') {
                  new_item +=
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Lunch\"><img src=\"{% static 'experiences/img/lunch.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Dinner\"><img src=\"{% static 'experiences/img/dinner.svg' %}\"></button>";
                } else if (type == 'suggestion') {
                  new_item +=
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Car driver\"><img src=\"{% static 'experiences/img/cardriver.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Activities\"><img src=\"{% static 'experiences/img/hot-56.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Lunch\"><img src=\"{% static 'experiences/img/lunch.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Dinner\"><img src=\"{% static 'experiences/img/dinner.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Accommodation\"><img src=\"{% static 'experiences/img/accommodation.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Bus\"><img src=\"{% static 'experiences/img/bus.svg' %}\"></button>" +
                  "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Ferry\"><img src=\"{% static 'experiences/img/boat.svg' %}\"></button>";
                } else if (type == 'pricing') {

                }
                new_item +=
                "</div></div>" +
                "<div class=\"exp-price\">" +
                  "<div class=\"container-fluid\">" +
                    "<span class=\"inline-text fixed-price-min\">" + fixed_price_min + "</span><div class=\"slider slider-price-base\"></div><span class=\"inline-text fixed-price-max\">" + fixed_price_max + "</span>" +
                    "<p>" +
                      "<input typy=\"text\" class=\"fixed-price\" readonly>" +
                      "<label>{% trans 'base' %}</label>" +
                    "</p>" +
                  "</div>" +
                  "<div class=\"container-fluid\">" +
                    "<span class=\"inline-text price-min\">"+ price_min + "</span><div class=\"slider slider-price-pp\"></div><span class=\"inline-text price-max\">" + price_max + "</span>" +
                    "<p>" +
                      "<input type=\"text\" class=\"price\" readonly>" +
                      "<label>{% trans 'pp' %}</label>" +
                    "</p>" +
                  "</div>" +
                "</div></div>";
                $("#"+type+"_column").append(new_item);
                $("#"+type+"_column").fadeIn();
                $("#" + type + "-title").val("");
                $("#" + type + "-details").val("");
                $("#" + type + "-location").val("");
                $("#" + type + "-fixed_price").val("");
                $("#" + type + "-price").val("");
                $("#" + type + "-fixed_price-min").val("");
                $("#" + type + "-fixed_price-max").val("");
                $("#" + type + "-price-min").val("");
                $("#" + type + "-price-max").val("");
                $("#" + type + "-notes").val("");
                $("#" + type + "-photo").val("");
                $(".fileinput").fileinput('clear');
                $("#add-"+type).hide();
                $("#add-"+type+"-btn").show();
                $(".loading").hide();
                init_drag();
        }).fail(function(jqXHR, textStatus) {
                $(".loading").hide();
                if(textStatus === 'timeout')
                {
                    alert('Request timeout');
                }
        });
    }

    function duplicate_item(id, type) {
      var experience = $($(".experience_id_" + id)[0]);
      var fixed_price = parseFloat(experience.find(".fixed-price").text())
      var price = parseFloat(experience.find(".price").text());
      var fixed_price_min = parseFloat(experience.find(".fixed-price-min").text());
      var fixed_price_max = parseFloat(experience.find(".fixed-price-max").text());
      var price_min = parseFloat(experience.find(".price-min").text());
      var price_max = parseFloat(experience.find(".price-max").text());
      var title = experience.find(".exp-info").find("h3").text();
      var details = $(experience.find(".exp-info").find("p")[0]).text();
      var notes = experience.find(".exp-info").find("label").text();

      var new_item =  "<div class=\"experience_id_" + id + " exp-box-sm\">" +
                        "<div class=\"exp-img\"><img src=\"{{MEDIA_URL}}thumbnails/experiences/experience" + id + "_1.jpg\" style=\"width:inherit;height:inherit;\"></div>" +
                        "<div class=\"exp-info\">" +
                          "<h3>" + title + "</h3>" +
                          "<p>" + details + "</p>" +
                          "<label style=\"display:none;\">" + notes + "</label>";

      new_item +=
      "<p class=\"exp-edit\">" +
        "<a type=\"button\" onclick=\"edit_item(" + id + ", '" + type + "');\">{% trans "Edit" %}</a>" +
        " &middot; " +
        "<a type=\"button\" onclick=\"duplicate_item(" + id + ", '" + type + "');\">{% trans "Duplicate" %}</a>" +
        " &middot; " +
        "<a type=\"button\" onclick=\"delete_item(" + id + ", '" + type + "');\">{% trans "Delete" %}</a>" +
      "</p><div class=\"whats-included\">";

      if (type == 'PrivateProduct' || type == 'PublicProduct' || type == 'PRIVATE' || type == 'NONPRIVATE') {
        new_item +=
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Car driver\"><img src=\"{% static 'experiences/img/cardriver.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Activities\"><img src=\"{% static 'experiences/img/hot-56.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Lunch\"><img src=\"{% static 'experiences/img/lunch.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Dinner\"><img src=\"{% static 'experiences/img/dinner.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Bus\"><img src=\"{% static 'experiences/img/bus.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Ferry\"><img src=\"{% static 'experiences/img/boat.svg' %}\"></button>";
      } else if (type == 'flight') {
        new_item +=
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Flight\"><img src=\"{% static 'experiences/img/flight.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Lunch\"><img src=\"{% static 'experiences/img/lunch.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Dinner\"><img src=\"{% static 'experiences/img/dinner.svg' %}\"></button>";
      } else if (type == 'transfer') {
        new_item +=
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Airport pickup\"><img src=\"{% static 'experiences/img/airportpickup.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Airport dropoff\"><img src=\"{% static 'experiences/img/airportdropoff.svg' %}\"></button>";
      } else if (type == 'accommodation') {
        new_item +=
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Accommodation\"><img src=\"{% static 'experiences/img/accommodation.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>";
      } else if (type == 'restaurant') {
        new_item +=
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Lunch\"><img src=\"{% static 'experiences/img/lunch.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Dinner\"><img src=\"{% static 'experiences/img/dinner.svg' %}\"></button>";
      } else if (type == 'suggestion') {
        new_item +=
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Car driver\"><img src=\"{% static 'experiences/img/cardriver.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Activities\"><img src=\"{% static 'experiences/img/hot-56.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Breakfast\"><img src=\"{% static 'experiences/img/breakfast.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Lunch\"><img src=\"{% static 'experiences/img/lunch.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Dinner\"><img src=\"{% static 'experiences/img/dinner.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Accommodation\"><img src=\"{% static 'experiences/img/accommodation.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Bus\"><img src=\"{% static 'experiences/img/bus.svg' %}\"></button>" +
        "<button type=\"button\" class=\"btn btn-default whats-included-btn\" data-toggle=\"button\" aria-pressed=\"false\" autocomplete=\"off\" value=\"Ferry\"><img src=\"{% static 'experiences/img/boat.svg' %}\"></button>";
      } else if (type == 'pricing') {

      }

      new_item +=
      "</div></div><div class=\"exp-price\">" +
        "<div class=\"container-fluid\">" +
          "<span class=\"inline-text fixed-price-min\">" + fixed_price_min + "</span><div class=\"slider slider-price-base\"></div><span class=\"inline-text fixed-price-max\">" + fixed_price_max + "</span>" +
          "<p>" +
            "<input typy=\"text\" class=\"fixed-price\" readonly>" +
            "<label>{% trans 'base' %}</label>" +
          "</p>" +
        "</div>" +
        "<div class=\"container-fluid\">" +
          "<span class=\"inline-text price-min\">"+ price_min + "</span><div class=\"slider slider-price-pp\"></div><span class=\"inline-text price-max\">" + price_max + "</span>" +
          "<p>" +
            "<input type=\"text\" class=\"price\" readonly>" +
            "<label>{% trans 'pp' %}</label>" +
          "</p>" +
        "</div>" +
      "</div></div>";
      $("#"+type+"_column").append(new_item);
    }


    function edit_item(id, type)
    {
        $("#add-" + type + "-btn").click();
        var experience = $($(".experience_id_" + id)[0]);
        var fixed_price = parseFloat(experience.find(".fixed-price").text())
        var price = parseFloat(experience.find(".price").text());
        var fixed_price_min = parseFloat(experience.find(".fixed-price-min").text());
        var fixed_price_max = parseFloat(experience.find(".fixed-price-max").text());
        var price_min = parseFloat(experience.find(".price-min").text());
        var price_max = parseFloat(experience.find(".price-max").text());
        var title = experience.find(".exp-info").find("h3").text();
        var details = $(experience.find(".exp-info").find("p")[0]).text();
        var notes = experience.find(".exp-info").find("label").text();

        if(isNaN(parseFloat(fixed_price)))
        {
            fixed_price = 0;
        }
        if(isNaN(parseFloat(price)))
        {
            price = 0;
        }

        $("#" + type + "-fixed_price-min").val(fixed_price_min);
        $("#" + type + "-fixed_price-max").val(fixed_price_max)
        $("#" + type + "-price-min").val(price_min)
        $("#" + type + "-price-max").val(price_max)
        $("#" + type + "-price").val(price);
        $("#" + type + "-title").val(title);
        $("#" + type + "-details").val(details);
        $("#" + type + "-notes").val(notes);
        $("#add-" + type + "-add").text("{% trans "Save" %}");
        $("#add-" + type + "-add").attr("onclick", "");
        $("#add-" + type + "-add").click(function(e){
            var item = new FormData();
            item.append("csrfmiddlewaretoken", $("[name='csrfmiddlewaretoken']")[0].value);
            item.append("Edit", "Edit");
            item.append("id", id);

            var ids = ["title", "location", "fixed_price-min", "fixed_price-max", "price-min", "price-max", "fixed_price", "price", "details", "notes"];
            var value = "";

            for (var i = 0, j = 0; i < ids.length; i++) {
                value = $("#" + type + "-" + ids[i]).val();
                if(value)
                {
                    item.append([ids[i]], value);
                    j++;
                }
            }

            if(j == 0)
            {
                alert("Fill at least one field");
                return;
            }
            if($("#"+type+"-photo")[0] && $("#"+type+"-photo")[0].files.length > 0)
            {
                file = $("#"+type+"-photo")[0].files[0];
                if(file.size > 2097152)
                {
                    alert("{% trans "Image size exceeds the limit (2M)" %}");
                    return;
                }
                if(file.type.indexOf("image/") < 0)
                {
                    alert("{% trans "Invalid image type" %}");
                    return;
                }
                item.append("file", file);
            }
            $(".loading").show();
            $.ajax({
                url: '{{GEO_POSTFIX}}itinerary/',
                type: "POST",
                async: true,
                data: item,
                processData: false,
                contentType: false
            }).done(function (data) {
                                var fixed_price_min = parseFloat($("#" + type + "-fixed_price-min").val());
                                var fixed_price_max = parseFloat($("#" + type + "-fixed_price-max").val());
                                var fixed_price =  (fixed_price_min + fixed_price_max)/2;
                                var price_min = parseFloat($("#" + type + "-price-min").val());
                                var price_max = parseFloat($("#" + type + "-price-max").val());
                                var price = (price_min + price_max)/2;
                                experience.find(".fixed-price-min").text(fixed_price_min);
                                experience.find(".fixed-price-max").text(fixed_price_max);
                                experience.find(".price-min").text(price_min);
                                experience.find(".price-max").text(price_max);
                                experience.find(".fixed-price").val(fixed_price);
                                experience.find(".price").val(price);
                                experience.find(".exp-info").find("h3").text($("#" + type + "-title").val());
                                $(experience.find(".exp-info").find("p")[0]).text($("#" + type + "-details").val());
                                experience.find(".exp-info").find("label").text($("#" + type + "-notes").val());
                                $("#add-" + type + "-add").text("{% trans "Add" %}");
                                $("#add-" + type + "-add").unbind("click");
                                $("#add-" + type + "-add").attr("onclick", "add_item('" + type + "');");
                                $("#" + type + "_column").fadeIn();
                                $("#" + type + "-title").val("");
                                $("#" + type + "-details").val("");
                                $("#" + type + "-notes").val("");
                                $("#" + type + "-location").val("");
                                $("#" + type + "-fixed_price").val("");
                                $("#" + type + "-price").val("");
                                $("#" + type + "-fixed_price-min").val("");
                                $("#" + type + "-fixed_price-max").val("");
                                $("#" + type + "-price-min").val("");
                                $("#" + type + "-price-max").val("");
                                $("#add-" + type).hide();
                                $("#add-"+type+"-btn").show();
                                $(".loading").hide();
                                init_drag();
            }).fail(function(jqXHR, textStatus) {
                    $(".loading").hide();
                    if(textStatus === 'timeout')
                    {
                        alert('Request timeout');
                    }
            });
        });
    }

    function delete_item(id)
    {
        var item = new FormData();
        item.append("csrfmiddlewaretoken", $("[name='csrfmiddlewaretoken']")[0].value);
        item.append("Delete", "Delete");
        item.append("id", id);
        $.ajax({
            url: '{{GEO_POSTFIX}}itinerary/',
            type: "POST",
            async: true,
            data: item,
            processData: false,
            contentType: false
        }).done(function (data) {
                $(".experience_id_" + id).remove();
        }).fail(function(jqXHR, textStatus) {
                $(".loading").hide();
                if(textStatus === 'timeout')
                {
                    alert('Request timeout');
                }
        });
    }

    function update_price_title(event, ui)
    {
        if(event && ui && $(ui.item[0]).find(".exp-edit").length > 0)
        {
            if(ui.item.parent()[0].id && ui.item.parent()[0].id.indexOf("_column") > 0)
            {
                //dropped in the left section
                $($(ui.item[0]).find(".exp-edit")[0]).show();
                $($(ui.item[0]).find(".whats-included")[0]).hide();

            }
            else
            {
                //dropped in the right section
                $($(ui.item[0]).find(".exp-edit")[0]).hide();
                $($(ui.item[0]).find(".whats-included")[0]).show();
                if (!$(ui.item[0]).hasClass("added")) {
                  var classes = $(ui.item[0]).attr("class").split(" ");
                  var id = classes[0].split("_");
                  var type = $(".tab-pane.active").attr("id");
                  $(ui.item[0]).addClass("added");
                  duplicate_item(id[id.length-1], type);
                  init_slider($(ui.item[0]));
                }
            }
        }

        var city = $("#sortable > :nth-child(1) > :nth-child(2)")[0];
        var price = 0;
        var fixed_price = 0;

        while(city && city.id.indexOf("city-collapse-") === 0)
        {
            var c = $(city).prev().attr("city");
            var day = $(city).children()[0];
            while(day && day.id.indexOf("city-collapse-") === 0)
            {
                var experience = $(day).find(".column")[0].firstElementChild;
                while(experience && $(experience).hasClass("exp-box-sm"))
                {
                    var fixed = $(experience).find(".fixed-price").val();
                    if (isNaN(parseFloat(fixed))) {
                      fixed = $(experience).find(".fixed-price").text();
                    }
                    var tmp = $(experience).find(".price").val();
                    if (isNaN(parseFloat(tmp))) {
                      tmp = $(experience).find(".price").text();
                    }
                    price += parseFloat(tmp);
                    fixed_price += parseFloat(fixed);
                    experience = $(experience).next()[0];
                }
                day = $(day).next()[0];
            }
            city = $(city).parent().next().children()[1];
        }
        if(price < 0)
        {
            price=0;
        }
        guest_number = parseInt($("#id_adult_number").val()) + parseInt($("#id_children_number").val());
        $("#price-pp").text(Math.round(price+fixed_price/guest_number));
        $("#price-tt").text(Math.round(price*guest_number+fixed_price));
    }

    function set_new_item_location(type)
    {
        if($(".collapse.in").length>0)
        {
            var id = $(".collapse.in")[0].id.split("-");
            id = id[id.length-1];
            var city = $($("#city-title-"+id)[0]).attr("city");
            $("#"+type+"-location").val(city);
        }
    }
    </script>
{% endblock %}
